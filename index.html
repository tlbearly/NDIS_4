<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no" />

  <!-- never load from cache -->
  <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0" />
  <meta http-equiv="cache-control" content="max-age=0" />
  <meta http-equiv="expires" content="0" />
  <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=7,IE=9,IE=10,IE=11" />

  <title>Test ArcGIS API for JavaScript 4.30</title>

  <script src="https://js.arcgis.com/4.30/"></script>
  <script type="module" src="https://js.arcgis.com/calcite-components/2.13.0/calcite.esm.js"></script>
 
  
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/light/main.css" async="true" />
  <link rel="stylesheet" href="./assets/css/main.css?v=1" async="true" />
  
  <link rel="stylesheet" href="./assets/css/custom-theme.css?v=13" async="true" />
  
  <!--link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/2.13.0/calcite.css" /-->

  <script type="text/javascript" src="js/xmlUtils.js?v=1" async="true"></script>
  <script type="text/javascript" src="js/disclaimer.js" async="true"></script>
  <script type="text/javascript" src="js/utilFuncs.js?v=5" async="true"></script>
  <script type="text/javascript" src="js/addMapLayers.js?v=16" async="true"></script>
  <script type="text/javascript" src="js/customBasemaps.js?v=17" async="true"></script>
  <script type="text/javascript" src="js/myLayerList.js?v=88" async="true"></script>
  <script type="text/javascript" src="js/identify.js?v=2" async="true"></script>
  <!--script type="text/javascript" src="js/myMapLayers.js?v=13" async="true"></script-->
  <script type="text/javascript" src="js/myMeasure.js?v=0" async="true"></script>


  
  <!--link rel="stylesheet" type="text/css" href="assets/css/myCalcite.css" /-->

  <script>
    // force rounded corners
    window.onload = function () {
      // Add rounded corners to layer list
      const tim = setInterval(function () {
        if (!document.querySelector("#layerlist")) return;
        if (!document.querySelector("#layerlist").shadowRoot) return;
        if (!document.querySelector("#layerlist").shadowRoot.children) return;
        if (document.querySelector("#layerlist").shadowRoot.children.length < 1) return;
        clearInterval(tim);
        document.querySelector("#layerlist").shadowRoot.querySelector("calcite-panel").style.borderRadius = "0.75rem";
        document.querySelector("#layerlist").shadowRoot.querySelector("calcite-panel").parentNode.parentNode.style.marginRight = "10px";
        document.querySelector("#layerlist").shadowRoot.querySelector("calcite-panel").parentNode.parentNode.style.marginTop = "10px";
        setTimeout(function(){
          // layer list sub-dialogs for each root layer in the map
          for (var i = 0; i < mapLayers.length; i++) {
            if (document.querySelector("#" + mapLayers[i].title.replace(/ /g, "_") + "_dialog") &&
              document.querySelector("#" + mapLayers[i].title.replace(/ /g, "_") + "_dialog").shadowRoot &&
              document.querySelector("#" + mapLayers[i].title.replace(/ /g, "_") + "_dialog").shadowRoot.querySelector("calcite-panel")){
              document.querySelector("#" + mapLayers[i].title.replace(/ /g, "_") + "_dialog").shadowRoot.querySelector("calcite-panel").style.borderRadius = "0.75rem";
              document.querySelector("#" + mapLayers[i].title.replace(/ /g, "_") + "_dialog").shadowRoot.querySelector("calcite-panel").parentNode.parentNode.style.marginRight = "10px";
              document.querySelector("#" + mapLayers[i].title.replace(/ /g, "_") + "_dialog").shadowRoot.querySelector("calcite-panel").parentNode.parentNode.style.marginTop = "10px";
              }
          }
        },1000);
        
      }, 500);
    };
  </script>

  <script>
    var app = "huntingatlas";
    var map, view, mapLayers = [];
    var  queryObj;
    const ndisVer = Date.now();
    // this is read from SettingsWidget.xml file in identify.js readSettingsWidget()
    var settings = {
      elkField: "GMUID",
      elkUrl: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_AssetReport_Data/MapServer/2",
      sheepField: "BSGMU",
      sheepUrl: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_AssetReport_Data/MapServer/15",
      goatField: "MGGMU",
      goatUrl: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_AssetReport_Data/MapServer/16"
    };
    var XMLHttpRequestObjects = []; // holds database call object
    var gmu = "Big Game GMU";
    var searchWidget;
    var hideGroupSublayers = ["Emergency", "Field Office", "Chamber of Commerce or Welcome Center", "2License Agent", "Campgrounds and SWA Facilities", "GMU boundary (Hunting Units)"];
    var labelFromURL = false;
    // Protect against XSS attacks
    // preserve new lines in way point descriptions (For future changes, if we decide to add them like the Mobile version.)
    //var location = document.location.search.replace(/\%0D/g,"newline");
    var queryObj = new URL(window.location.toLocaleString()).searchParams;
    app = queryObj.get("app");
    if (!app)
        app = "HuntingAtlas";
    else {
        regexp=/([^a-zA-Z])/g; // only allow letters in the app name
        if (regexp.test(app)) alert("Illegal characters were removed from the application name. Only letters allowed.","Warning");
        app = app.replace(regexp,""); // clean it
    }
    require(["esri/config",
      // -- map, basemaps layers --
      "esri/Map",
      "esri/views/MapView",
      "esri/layers/VectorTileLayer",
      "esri/layers/TileLayer",
      "esri/layers/MapImageLayer",
      "esri/layers/FeatureLayer",
      "esri/layers/GraphicsLayer",
      "esri/layers/GroupLayer",
      // -- Geomtry --
      "esri/PopupTemplate",
      "esri/Graphic",
      "esri/geometry/Extent",


      // -- widgets --
      "esri/widgets/Expand",
      "esri/widgets/LayerList",
      "esri/widgets/Legend",
      "esri/widgets/Locate",
      "esri/widgets/Search",
      "esri/widgets/ScaleBar",
      "esri/widgets/Slider",

      "esri/widgets/Print"],
      function (esriConfig, Map, MapView, VectorTileLayer, TileLayer, MapImageLayer, FeatureLayer, GraphicsLayer, GroupLayer, PopupTemplate, Graphic, Extent, Expand, LayerList, Legend, Locate, Search, ScaleBar, Slider, Print) {

        //esriConfig.apiKey = "YOUR_API_KEY";


        // TEST reading data from database
        /*layer = new FeatureLayer({
              portalItem: { // autocasts as esri/portal/PortalItem
                id: "02513fefd87149b4b09b5df4dcd6f5ec" //
              } 
            }),
            // Test identify from database looking up ancestry data from a table joined to the map service
            new FeatureLayer({
              url: "https://sampleserver6.arcgisonline.com/arcgis/rest/services/AGP/Census/MapServer",
              title: "United States Population",
              visible: false,
              popupTemplate: {
                title: "{states.STATE_NAME}",
                content: "{expression/per_ancestry}% of the {states.POP2007} people in {states.STATE_NAME} have "
                  + "Norwegian ancestry.",
                expressionInfos: [{
                  name: "per_ancestry",
                  expression: "Round( ( $feature['ancestry.norwegian'] / $feature['states.POP2007'] ) * 100, 1)"
                }],
                fieldInfos: [{
                  fieldName: "states.POP2007",
                  format: {
                    digitSeparator: true,
                    places: 0
                  }
                }]
              },
              dynamicDataSource: {
                type: "data-layer",
                dataSource: {
                  type: "join-table",
                  leftTableSource: {
                    type: "map-layer",
                    mapLayerId: 3
                  },
                  rightTableSource: {
                    type: "data-layer",
                    dataSource: {
                      type: "table",
                      workspaceId: "CensusFileGDBWorkspaceID",
                      dataSourceName: "ancestry"
                    }
                  },
                  leftTableKey: "STATE_NAME",
                  rightTableKey: "State",
                  joinType: "left-outer-join"
                }
              }
            }),*/




        // Hunter Reference
        // TileLayer sublayers are read only except for legendEnabled, popupEnabled, popupTemplate, and title. Error incompatible with basemap spatial reference
        /*var layer = new MapImageLayer({
          title: "Hunter Reference", // must be named Hunter Reference
          url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_Base_Map/MapServer"
        });
        layer.when((event) => {
          for (var i = 0; i < event.sublayers.items.length; i++) {
            if (event.sublayers.items[i].title.indexOf("Land Management") > -1) {
              event.sublayers.items[i].popupTemplate = {
                title: "Land Management",
                content: "{NAME}<br>{MANAGER}"
              };
              event.sublayers.items[i].opacity = 0.4;
            }
          }

          console.log("Hunter Reference loaded");
        });
        mapLayers.push(layer);



        layer = new MapImageLayer({
          title: "Hunter Reference2", // must be named Hunter Reference
          url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_Base_Map/MapServer",
          sublayers: [
            {
              title: "Land Management (COMaP v20240702)",
              id: 103,
              popupTemplate: {
                title: "Land Management",
                content: "{NAME}<br>{MANAGER}"
              }
            },
            {
              title: "Township Range Sections",
              id: 97,
              visible: false,
              listMode: "show",
              legendEnabled: true,
              sublayers: [
                {
                  title: "Township Range boundary",
                  id: 99,
                  listMode: "hide",
                  legendEnabled: true,
                  visible: true
                },
                {
                  title: "Section boundary",
                  id: 98,
                  listMode: "hide",
                  legendEnabled: true,
                  visible: true
                }
              ]
            },
            {
              title: "Continental Divide",
              id: 96,
              listMode: "hide",
              legendEnabled: true,
              minScale: 250000
            },
            {
              title: "License Agent",
              id: 2,
              listMode: "show", // visible in TOC? show|hide|hide-children
              legendEnabled: true, // visible in legend? true|false
              popupTemplate: {
                title: "{License Agent}",
                content: "{Name}<br>{Manager}<br>{Address}<br>{City}<br>{Phone}"
              }
            },
            {
              title: "CPW Public Access Properties",
              id: 102,
              listMode: "show", // visible in TOC? show|hide|hide-children
              legendEnabled: true, // visible in legend? true|false
              popupTemplate: {
                title: "CPW Public Access Properties",
                content: "Name: {PropName}<br>Property type: {PropType}"
              }
            }
          ]
        });
        mapLayers.push(layer);

        // Game Species
        layer = new MapImageLayer({
          title: "Game Species",
          url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_BigGame_Map/MapServer",
          visible: false
        });
        layer.when((event) => {
          console.log("Game Species loaded");
        });
        mapLayers.push(layer);

        // BLM Roads and Trails
        layer = new MapImageLayer({
          title: "BLM Roads and Trails",
          url: "https://gis.blm.gov/coarcgis/rest/services/transportation/BLM_CO_GTLF/MapServer",
          visible: false
        });
        mapLayers.push(layer);

        // MVUM Roads and Trails
        layer = new MapImageLayer({
          title: "MVUM",
          url: "https://apps.fs.usda.gov/arcx/rest/services/EDW/EDW_MVUM_02/MapServer",
          visible: true,
          sublayers: [
            {
              id: 2,
              title: "Trails",
              visible: true,
              minScale: 250000,
              popupTemplate: {
                title: "{NAME}",
                content: "{NAME}<br>Segment length: {expression/seg-length} mi.<br>{JURISDICTION}<br>Seasonal: {SEASONAL}",
                // format segment length to one decimal place
                expressionInfos: [{
                  name: "seg-length",
                  expression: "Round($feature.SEG_LENGTH , 1)"
                }]
              }
            },
            {
              id: 1,
              title: "Roads",
              visible: true,
              minScale: 250000,
              popupTemplate: {
                title: "{NAME}",
                content: "Segment length: {expression/seg-length} mi.<br>{JURISDICTION}<br>Seasonal: {SEASONAL}" +
                  "Passenger vehicle: {PASSENGERVEHICLE}",
                // format segment length to one decimal place
                expressionInfos: [{
                  name: "seg-length",
                  expression: "Round($feature.SEG_LENGTH , 1)"
                }]
              }
            }
          ]
        });
        mapLayers.push(layer);

        // wildfire
        layer = new FeatureLayer({
          title: "Wildfire points",
          url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/ArcGIS/rest/services/USA_Wildfires_v1/FeatureServer/0",
          visible: true
        });
        mapLayers.push(layer);
        layer = new FeatureLayer({
          title: "Wildfire perimeter",
          url: "https://services9.arcgis.com/RHVPKKiFTONKtxq3/ArcGIS/rest/services/USA_Wildfires_v1/FeatureServer/1",
          visible: true
        });
        mapLayers.push(layer);

        /* new GroupLayer({
          title: "Game Species",
          id: "Game Species",
          visible: false,
          opacity: 0.7,
          visibilityMode: "exclusive", // radio buttons
          layers: [
            new GroupLayer({
              title: "Mountain Goat",
              visible: false,
              layers: []
            }),
            new GroupLayer({
              title: "Elk",
              visible: true,
              layers: [
              new FeatureLayer({
                  title: "Overall Range",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/44",
                  visible: false,
                  legendEnabled: true,
                  popupTemplate: {
                    title: "Elk",
                    content: "Elk overall range. Last updated: {EDIT_DATE}"
                  }
                }),
                new FeatureLayer({
                  title: "Resident Population Area",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/39",
                  visible: true,
                  legendEnabled: true,
                  popupTemplate: {
                    title: "Elk",
                    content: "Elk resident population area. Last updated: {EDIT_DATE}"
                  }
                }),
                new FeatureLayer({
                  title: "Summer Range",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/36",
                  visible: true,
                  legendEnabled: true,
                  popupTemplate: {
                    title: "Elk",
                    content: "Elk summer range. Last updated: {EDIT_DATE}"
                  }
                }),
                new FeatureLayer({
                  title: "Summer Concentration Area",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/35",
                  visible: false,
                  legendEnabled: true
                }),
                new FeatureLayer({
                  title: "Winter Range",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/43",
                  visible: true,
                  legendEnabled: true
                }),
                new FeatureLayer({
                  title: "Winter Concentration Area",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/42",
                  visible: true,
                  legendEnabled: true
                }),
                new FeatureLayer({
                  title: "Migration Corridors",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/40",
                  visible: true,
                  legendEnabled: true
                }),
                new FeatureLayer({
                  title: "Migration Patterns",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/33",
                  visible: false,
                  legendEnabled: true
                })
              ]
            }),
            new GroupLayer({
              title: "Bighorn", // Must be named Bighorn
              visible: false,
              layers: [
                new FeatureLayer({
                  title: "Migration Patterns",
                  url:"https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/8",
                  visible: false,
                  legendEnabled: true
                }),
                new FeatureLayer({
                  title: "Migration Corridors",
                  url: "https://services5.arcgis.com/ttNGmDvKQA7oeDQ3/ArcGIS/rest/services/CPWSpeciesData/FeatureServer/9",
                  visible: true,
                  legendEnabled: true
                })
              //layerIds="8,9,15-17,10,11,18"
              //layerVis="false,true,true,true,true,false,true,false"                     
              ]
            })
          ]
        })*/


        // Hunter Reference
        /*let layer = 
        layer.popupTemplate = {
          expressionInfos: [{
            name: "participation-rate",
            title: "% of population 16+ participating in the labor force",
            expression: "Round(($feature.CIVLBFR_CY / $feature.POP_16UP)*100,2)"
          }],
          content: "In {NAME} county, {expression/participation-rate}% of the population"
            + " participates in the labor force."
        };*/

        // Add map layers in reversion order top most will be on bottom of TOC!!!
        map = new Map({
          spatialReference: {
            wkid: 102100
          },
          basemap:"streets"
          //layers: mapLayers
        });
        var openTOCgroups = ["Elk"]; // which group layers should be open in TOC
        //#endregion
        const graphicsLayer = new GraphicsLayer();
        graphicsLayer.title = "Graphics Layer";
        map.add(graphicsLayer);
        let initExtent = new Extent({
          "xmin": -12350000,
          "ymin": 4250000,
          "xmax": -11150000,
          "ymax": 5250000,
          "spatialReference": {
            "wkid": 102100
          }
        });
        view = new MapView({
          map: map,
          extent: initExtent,
          container: "viewDiv", // Div element
          extent: initExtent,
          popup: {
            dockEnabled: true,
            dockOptions: {
              // Disables the dock button from the popup
              buttonEnabled: false,
              // Ignore the default sizes that trigger responsive docking
              breakpoint: false,
              position: "top-left"
            }
          }
        });

        const nonLayers = ["Graphics Layer", "World Hillshade", "World Imagery", "USGSTopo", "USA Topo Maps", "USGSImageryTopo", "", "World Topo Map", "World Basemap", "World Basemap v2"];

        // Handle Filling Identify Content Here
        view.on("click", function (event) {
          //var pt = event.MapPoint();
          doIdentify(event);
        });

        view.when(() => {
          // test using esri layerlist
          //myMapLayers();
          const cpw_link = document.createElement("a");
          cpw_link.href="cpw.state.co.us";
          cpw_link.style.paddingRight="10px";
          cpw_link.setAttribute("alt","load CPW website");
          cpw_link.id = "logourl";
          
          const titlediv=document.createElement("div");
          titlediv.style.padding="5px";
          titlediv.style.borderRadius="12px";
          titlediv.style.margin="0 0 -45px 0px";
          titlediv.id = "titleDiv";
          if (screen.width > 768)
            titlediv.style.minWidth="320px";
          else
            titlediv.style.minWidth="244px";
          titlediv.style.height="70px";//"115px";
          titlediv.style.border="2px solid white";
          const title=document.createElement("span");
          title.style.fontSize="1.4em";
          title.style.lineHeight="1.3em";
          title.style.position="relative";
          title.id = "title";
          
          const logo = document.createElement("img");
          logo.id = "logo";
          logo.src = "./assets/images/logo.svg";
          logo.setAttribute("alt", "CPW logo");
          if (screen.width <= 768)
            logo.setAttribute("width","30");
          else
            logo.setAttribute("width","70");
          logo.style.float="left";
          logo.setAttribute("align","middle");
          cpw_link.appendChild(logo);
          titlediv.appendChild(cpw_link);
          titlediv.appendChild(title);
          view.ui.add(titlediv,"top-left");

          // + - zoom buttons
          view.ui.move("zoom", "bottom-right");

          /*view.popup.visibleElements = {
            closeButton: false
          };*/
          addFindPlace();
          readSettingsWidget(); // identify
          addMeasure(graphicsLayer);






         



          // Old layer list
          /*layerList2 = new LayerList({
            view: view,
            title: "Map Layers",
            dragEnabled: false, // add drag layers to re-arrange draw order
            //visibilityAppearance: "checkbox",
            listItemCreatedFunction: defineActions,
            visibleElements: {
              catalogLayerList: true,
              closeButton: true,
              //collapseButton: true,
              errors: true,
              //filter: true,
              heading: true,
              statusIndicators: true
            }
          });
          const layerListExpand2 = new Expand({
            view,
            content: layerList2,
            expandTooltip: "Map Layers2",
            expandIconClass: "esri-icon-layers"
          });
          view.ui.add(layerListExpand2, "top-right");
          // Event listener that fires each time an action is triggered
          layerList2.on("trigger-action", (event) => {
              // The layer visible in the view at the time of the trigger.
              const layer = event.item.layer;
      	
              // Capture the action id.
              const id = event.action.id;
      	
              if (id === "full-extent") {
                // if the full-extent action is triggered then navigate
                // to the full extent of the visible layer
                view.goTo(visibleLayer.fullExtent)
                .catch((error) => {
                if (error.name != "AbortError"){
                  console.error(error);
                }
                });
              } else if (id === "information") {
                // if the information action is triggered, then
                // open the item details page of the service layer
                window.open(layer.url);
                window.open("/"+app+"/definitions.html");
              }else if (id === "increase-opacity") {
                // if the increase-opacity action is triggered, then
                // increase the opacity of the GroupLayer by 0.25
                if (layer.opacity < 2) {
                  layer.opacity += 0.25;
                }
              } else if (id === "decrease-opacity") {
                // if the decrease-opacity action is triggered, then
                // decrease the opacity of the GroupLayer by 0.25
                if (layer.opacity > 0) {
                  layer.opacity -= 0.25;
                }
              }
            });*/




          // MARK: -- Location --
          const locateBtn = new Locate({
            view: view
          });
          // Add the locate widget to the top left corner of the view
          view.ui.add(locateBtn, "bottom-right");


          // MARK: -- Print --    
          createPrintWidget("prtDisclaimer");

          readConfig();
        }); // view.when


        // *********************************
        // Creates actions in the LayerList.
        // *********************************
        var layerList;
        var gmuIndex = -1;

        function findGMUIndex() {
          // search Find a place widget sources to find index of GMU source
          for (var i = 0; i < searchWidget.sources.items.length; i++) {
            if (searchWidget.sources.items[i].name.indexOf("GMUs") > -1) {
              return i;
            }
          }
          return -1;
        }
        async function defineActions(event) {
          // The event object contains an item property.
          // is is a ListItem referencing the associated layer
          // and other properties. You can control the visibility of the
          // item, its title, and actions using this object.

          const item = event.item;
          await item.layer.when();

          if (item.title === "Graphics Layer") {
            item.hidden = true;
            return;
          }

          // hide group sub layers
          //if (item.title === "Hunter Reference"){
          item.children.forEach((subLayer) => {
            // hide children 2 layers deep if found in hideGroupSublayers
            if (hideGroupSublayers.includes(subLayer.title)) {
              // hide child layers
              subLayer.children.forEach((subSubLayer) => {
                subSubLayer.hidden = true;
                console.log("hiding " + subSubLayer.title);
              });
            }
            // hide children 3 layers deep if found in hideGroupSublayers
            subLayer.children.forEach((subSubLayer) => {
              if (hideGroupSublayers.includes(subSubLayer.title)) {
                // hide child layers
                subSubLayer.children.forEach((subSubSubLayer) => {
                  subSubSubLayer.hidden = true;
                  console.log("hiding " + subSubSubLayer.title);
                });
              }
            });
          });
          //}


          // Watch for layer change to visible. For exclusive layers, open selected layer and toggle other layers closed.
          // V Game Species (visibilityMode = exclusive)
          //     > Bighorn
          //     V Elk
          //     > Moose
          item.watch("visible", (event) => {
            if (app.toLowerCase() != "huntingatlas") return;
            // set gmu species && display GMU layer
            if (item.title === "Bighorn" && item.visible == true) {
              gmu = "Bighorn GMU";

              // switch searchWidget GMU layer to Bighorn GMUs
              // find the index of the Find a Place GMUs
              if (gmuIndex == -1) {
                gmuIndex = findGMUIndex();
              }
              if (gmuIndex != -1) {
                var bighornFL = new FeatureLayer({
                  url: settings.sheepUrl
                });
                searchWidget.sources.items[gmuIndex].layer = bighornFL;
                searchWidget.sources.items[gmuIndex].searchFields = [settings.sheepField];
                searchWidget.sources.items[gmuIndex].displayField = settings.sheepField;
                searchWidget.sources.items[gmuIndex].outFields = [settings.sheepField];
                searchWidget.sources.items[gmuIndex].name = "Bighorn Sheep GMUs";
                searchWidget.sources.items[gmuIndex].placeholder = "Search Bighorn GMUs";
              }
            }
            else if (item.title === "Mountain Goat" && item.visible == true) {
              gmu = "Goat GMU";
              // find the index of the Find a Place GMUs
              if (gmuIndex == -1) {
                gmuIndex = findGMUIndex();
              }
              if (gmuIndex != -1) {
                var goatFL = new FeatureLayer({
                  url: settings.goatUrl
                });
                searchWidget.sources.items[gmuIndex].layer = goatFL;
                searchWidget.sources.items[gmuIndex].searchFields = [settings.goatField];
                searchWidget.sources.items[gmuIndex].displayField = settings.goatField;
                searchWidget.sources.items[gmuIndex].outFields = [settings.goatField];
                searchWidget.sources.items[gmuIndex].name = "Mountain Goat GMUs";
                searchWidget.sources.items[gmuIndex].placeholder = "Search Goat GMUs";
              }
            }
            else {
              gmu = "Big Game GMU";
              // find the index of the Find a Place GMUs
              if (gmuIndex == -1) {
                gmuIndex = findGMUIndex();
              }
              if (gmuIndex != -1) {
                var elkFL = new FeatureLayer({
                  url: settings.elkUrl
                });
                searchWidget.sources.items[gmuIndex].layer = elkFL;
                searchWidget.sources.items[gmuIndex].searchFields = [settings.elkField];
                searchWidget.sources.items[gmuIndex].displayField = settings.elkField;
                searchWidget.sources.items[gmuIndex].outFields = [settings.elkField];
                searchWidget.sources.items[gmuIndex].name = "Big Game GMUs";
                searchWidget.sources.items[gmuIndex].placeholder = "Search GMUs";
              }
            }
            // Show correct GMU layer, hide others
            layerList2.operationalItems.every((opLayer) => { //every break on return false
              if (opLayer.title === "Hunter Reference") {
                opLayer.children.every((layerView) => {
                  if (layerView.title === "GMU boundary (Hunting Units)") {
                    layerView.children.forEach((gmuScale) => {
                      // Big Game GMU, Bighorn GMU, and Goat GMU
                      gmuScale.children.forEach((gmuAnimal) => {
                        switch (gmu) {
                          case "Big Game GMU":
                            if (gmuAnimal.title === "Big Game GMU") {
                              gmuAnimal.visible = true;
                            }
                            else {
                              gmuAnimal.visible = false; // don't show on map
                            }
                            break;
                          case "Bighorn GMU":
                            if (gmuAnimal.title === "Bighorn GMU") {
                              gmuAnimal.visible = true;
                            }
                            else {
                              gmuAnimal.visible = false; // don't show on map
                            }
                            break;
                          case "Goat GMU":
                            if (gmuAnimal.title === "Goat GMU") {
                              gmuAnimal.visible = true;
                            }
                            else {
                              gmuAnimal.visible = false; // don't show on map
                            }
                            break;
                        }
                      });
                    });
                    return false; // "GMU boundary (Hunting Units)" found, quit loop
                  }
                  return true; // "GMU boundary (Hunting Units)" not found yet
                });
                return false; // Hunter Reference found, quit loop
              }
              return true; // Hunter Reference not found yet
            });

            // open the selected radio button layers and close other radio buttons
            layerList2.operationalItems.forEach((opLayer) => {
              opLayer.children.forEach((layerView) => {
                if ((item.parent && item.parent.title === layerView.parent.title) && (item.parent.visibilityMode === "exclusive")) {
                  if (layerView.layer.id != item.layer.id) {
                    layerView.open = false;
                  } else {
                    layerView.open = true;
                  }
                }
              });
            });
          });

          // open the layer if specified in config.xml
          if (openTOCgroups.includes(item.title))
            item.open = true;

          // Adds a slider for updating a top level group or individual layer's opacity
          for (var i = 0; i < item.children.items.length; i++) {
            //if(item.children.length == 0 && item.parent) { // || item.parent === null ){
            const slider = new Slider({
              min: 0,
              max: 1,
              precision: 2,
              //values: [ item.layer.opacity ],
              values: [item.children.items[i].layer.opacity],
              visibleElements: {
                labels: true,
                rangeLabels: true
              },
              index: i // tlb save the child index children.items[index]
            });

            item.children.items[i].panel = {
              content: slider,
              className: "esri-icon-sliders-horizontal",
              title: "Change layer opacity"
            };

            slider.on("thumb-drag", (event) => {
              const { value } = event;
              item.children.items[slider.key.index].layer.opacity = value;
            });
          }



          // An array of objects defining actions to place in the LayerList.
          // By making this array two-dimensional, you can separate similar
          // actions into separate groups with a breaking line.

          // Add Information icon to top layers
          if (item.parent === null) {
            item.actionsSections = [
              [
                {
                  title: "Layer information",
                  className: "esri-icon-description",
                  id: "information"
                }
              ]
            ];
          }

          // show legend  
          if (item.layer.type != "group") {
            //if (item.parent == null){
            // don't show legend twice
            item.panel = {
              content: "legend",
              open: false,
              title: "Legend"
            };
          }
        }



        function addTempLabel(point, label, fontSize, shouldFade) {
          // Add text at a point. Fade out after 10 seconds.
          // point: Point, label: text, fontSize: int
          // if point is a polygon use the centroid
          // noFade: should it fade away? default is true
          require(["esri/symbols/TextSymbol", "esri/Graphic"], function (TextSymbol, Graphic) {
            //var shouldFade = true;
            //if (arguments.length >= 2) fontSize = 11;
            //else fontSize = arguments[2];
            //if (arguments.length == 4) shouldFade = false;

            label = label.replace(/''/g, "'");
            let textSymbol = new TextSymbol({
              text: label,
              color: "black",//[255, 255, 255],
              haloColor: [255, 255, 153, 1.0],//[1, 68, 33],
              haloSize: "2px",
              yoffset: -23,//-1 * (fontSize) - 3,
              font: {
                family: "Arial Unicode MS",
                size: fontSize
              }
            });
            if (point.geometry && point.geometry.type === "polygon")
              point = point.geometry.centroid;
            let pointText = new Graphic({
              geometry: point,
              symbol: textSymbol
            });
            view.graphics.add(pointText);
            let fade = 1.0; // starting transparency
            let width = pointText.symbol.haloSize / 4;
            // should fade out?
            if (shouldFade) {
              setTimeout(function () {
                let tim = setInterval(function () {
                  fade = fade - 0.25;
                  pointText.symbol.color.a = fade;
                  pointText.symbol.haloSize = pointText.symbol.haloSize - width;
                  pointText.symbol.haloColor.a = fade;
                  if (fade == 0) {
                    clearTimeout(tim);
                    view.graphics.remove(pointText);
                  }
                }, 2000);
              }, 5000);
            }
          });
        }
        function addTempPoint(pt, shouldFade) {
          // pt: Point
          // add point and remove it in 10 seconds
          // if noFade is passed in do not fade
          // added 4/25/24
          //var shouldFade = true;	
          //if (arguments.length == 2) shouldFade = false;
          require(["esri/symbols/PictureMarkerSymbol", "esri/Graphic"], function (PictureMarkerSymbol, Graphic) {
            const symbol = {
              type: "picture-marker",  // autocasts as new PictureMarkerSymbol()
              url: "/assets/images/i_flag.png",
              size: 24,
              width: 24,
              height: 24,
              xoffset: 0,
              yoffset: -12
            };
            let point = new Graphic({
              geometry: pt,
              symbol: symbol
            });
            view.graphics.add(point);
            if (shouldFade) {
              setTimeout(function () {
                view.graphics.remove(point);
              }, 13000);
            }
          });
        }

        const polySymbol = {
          type: "simple-line",  // autocasts as SimpleLineSymbol()
          color: [0, 255, 255], //[226, 119, 40],
          width: 3
        }
        function addTempPolygon(feature, shouldFade) {
          // add polygon outline and remove it in 10 seconds
          // if noFade is passed in do not fade
          //var shouldFade = true;	
          //if (arguments.length == 2) shouldFade = false;
          require(["esri/geometry/Polygon", "esri/Graphic"],
            function (Polygon, Graphic) {

              const polygon = new Polygon({
                rings: feature.geometry.rings,
                spatialReference: feature.geometry.spatialReference
              });
              const poly = new Graphic({
                geometry: polygon,
                symbol: polySymbol
              });
              view.graphics.add(poly);
              if (shouldFade) {
                setTimeout(function () {
                  view.graphics.remove(poly);
                }, 13000);
              }
            });
        }
        //**********************
        //   Add Search Widget
        //**********************
        async function addFindPlace() {
          // Find a Place Widget ESRI default
          //define layers for boundaries
          var countyFL = new FeatureLayer({
            url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_FindAPlaceTool_Data/MapServer/1",
            popupTemplate: {
              // autocasts as new PopupTemplate()
              title: "{COUNTYNAME} County",
              overwriteActions: true
            }
          });
          var propertyFL = new FeatureLayer({
            url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_AssetReport_Data/MapServer/3"
          });
          var gmuFL = new FeatureLayer({
            url: settings.elkUrl //"https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_AssetReport_Data/MapServer/2"
          });
          var forestFL = new FeatureLayer({
            url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_AssetReport_Data/MapServer/5"
          });
          var wildernessFL = new FeatureLayer({
            url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/HuntingAtlas/HuntingAtlas_AssetReport_Data/MapServer/4"
          });

          searchWidget = new Search({
            view: view,
            includeDefaultSources: false, // include ESRI geocode service "https://geocode-api.arcgis.com/arcgis/rest/services/World/GeocodeServer"
            searchAllEnabled: true, // if true has drop down list of sources includeing ESRI's
            popupEnabled: false,
            locationEnabled: false, // Adds option to go to current location
            resultGraphicEnabled: false, // Disable ESRI's graphic symbol, we will handle this below
            maxResults: 6,
            maxSuggestions: 50,
            suggestionsEnabled: true,
            minSuggestCharacters: 2,
            allPlaceholder: "Search",
            sources: [
              {
                layer: propertyFL,
                searchFields: ["PropName"],
                displayField: "PropName",
                exactMatch: false,
                maxSuggestions: 1000,
                outFields: ["PropName"],
                name: "CPW Properties (STL, SWA, SFU, or WWA)",
                placeholder: "Search CPW Properties"
              },
              {
                layer: gmuFL,
                searchFields: [settings.elkField],
                displayField: settings.elkField,
                exactMatch: false,
                maxResults: 6,
                maxSuggestions: 100,
                minSuggestCharacters: 1,
                outFields: [settings.elkField],
                name: "Big Game GMUs",
                placeholder: "Search GMUs"
              },
              {
                layer: forestFL,
                searchFields: ["MapName"],
                displayField: "MapName",
                exactMatch: false,
                outFields: ["MapName"],
                name: "Forests or Grasslands",
                placeholder: "Search Forests/Grasslands"
              },
              {
                layer: wildernessFL,
                searchFields: ["NAME"],
                displayField: "NAME",
                exactMatch: false,
                outFields: ["NAME"],
                name: "Wildernesses",
                placeholder: "Search Wildernesses"
              },
              {
                layer: countyFL,
                searchFields: ["COUNTYNAME"],
                displayField: "COUNTYNAME",
                exactMatch: false,
                outFields: ["COUNTYNAME"],
                name: "Counties",
                placeholder: "Search Counties"
              },
              // Colorado Place GNIS
              {
                url: "https://ndismaps.nrel.colostate.edu/ArcGIS/rest/services/GNIS_Loc/GeocodeServer",
                singleLineFieldName: "SingleLine",
                outFields: ["*"],
                name: "Colorado Places",
                placeholder: "Search Colorado Places"
              },
              // Address limit search to Colorado
              {
                filter: {
                  geometry: new Extent({
                    //-12350000 4250000 -11150000 5250000
                    xmax: -11150000,
                    xmin: -12350000,
                    ymax: 5250000,
                    ymin: 4250000,
                    spatialReference: {
                      wkid: 102100
                    }
                  })
                },
                url: "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer/",
                singleLineFieldName: "SingleLine",
                outFields: ["*"],
                name: "Address",
                placeholder: "Search Address"
              }
            ]
          });

          searchWidget.goToOverride = function (view, goToParams) {
            // Don't zoom in, we will handle it below
            return null;
          };

          searchWidget.on("search-complete", function (event) {
            // The results are stored in the event Object[]
            // Highlight and label the result for 10 seconds
            // Find which source layer matches name exactly or up to the comma. eg. Fort Collins, Larimer
            var index = 0;
            for (var i = 0; i < event.results.length; i++) {
              if (event.results[i].results.length == 0) continue;
              var name = event.results[i].results[0].name.toLowerCase();
              if (event.searchTerm.toLowerCase() === name.substring(0, name.indexOf(",")) ||
                event.searchTerm.toLowerCase() === name) {
                index = i;
                break;
              }
            }
            const obj = event.results[index];
            var newExtent = obj.results[0].extent;
            var pt;
            var fontsize = 11;
            for (i = 0; i < obj.results.length; i++) {
              if (obj.results[i].feature.geometry.type === "point") {
                require(["esri/geometry/Point"], function (Point) {
                  pt = new Point(obj.results[i].feature.geometry.x, obj.results[i].feature.geometry.y, obj.results[i].feature.geometry.spatialReference);
                  addTempPoint(pt, true);
                  if (labelFromURL) {
                    addTempLabel(pt, queryObj.get("label"), fontsize, true);
                    labelFromURL = false;
                  }
                  else addTempLabel(pt, obj.results[i].name, fontsize, true);
                });
              }
              else if (obj.results[i].feature.geometry.type === "polygon") {
                addTempPolygon(obj.results[i].feature, true);
                if (labelFromURL) {
                  addTempLabel(obj.results[i].feature, queryObj.get("label"), fontsize, true);
                  labelFromURL = false;
                }
                else if (obj.results[i].feature.sourceLayer.title.indexOf("GMU") > -1)
                  addTempLabel(obj.results[i].feature, "GMU " + obj.results[i].name, fontsize, true); // label each GMU polygon
                else if (obj.results[i].feature.sourceLayer.title.indexOf("County") > -1) {
                  var label = obj.results[i].name.toLowerCase();
                  var ch = label.substring(0, 1).toUpperCase();
                  label = ch + label.substring(1) + " County";
                  addTempLabel(obj.results[i].feature, label, fontsize, true); // label each county polygon
                }
                else addTempLabel(obj.results[i].feature, obj.results[i].name, fontsize, true); // label each polygon
                var thisExtent = obj.results[i].feature.geometry.extent;
                // making a union of the polygon extents  
                newExtent = newExtent.union(thisExtent);
              }
            }
            this.clear();
            if (obj.results[0].feature.geometry.type === "point")
              view.goTo({
                target: pt,
                scale: 24000
              });
            else
              view.extent = newExtent;
          });
          
          // Center in title div
          searchWidget.when(()=>{
            
            if (screen.width > 768) {
              searchWidget.container.style.left = "85px";
              searchWidget.container.style.position = "relative";
              searchWidget.container.style.top = "-2px";
            }
            else {
              searchWidget.container.style.left = "30px";
              searchWidget.container.style.marginRight = "auto";
              searchWidget.container.style.marginLeft = "auto";

            }
          });
          // Adds the search widget below other elements in
          // the top left corner of the view
          view.ui.add(searchWidget, {
            position: "top-left",
            index: 2
          });
        }


        function createPrintWidget(prtDisclaimer) {
          const print = new Print({
            view: view,
            // specify your own print service
            //printServiceUrl: printServiceUrl, // our print service does not print wildfire icons correctly (visual variables)
            allowedFormats: ["pdf", "jpg"],
            allowedLayouts: ["Letter ANSI A landscape", "Letter ANSI A portrait", "Tabloid ANSI B landscape", "Tabloid ANSI B portrait"],
            templateOptions: {
              author: prtDisclaimer,
              legendEnabled: true,
              dpi: 300
            },
            templateCustomTextElements: {
              "Subtitle": "subtitle"
            }
          });
          const printExpand = new Expand({
            view,
            content: print,
            expandTooltip: "Print",
            expandIconClass: "esri-icon-printer"
          });
          view.ui.add(printExpand, "bottom-right");
        }

      });
  </script>
</head>

<body class="green-theme">
  <calcite-loader id="loadingImg" label="Loading..." style="display:none;position:absolute;top:calc(50% - 90px);left:50%;z-index:4;"></calcite-loader>
  <div id="viewDiv"></div>
    <div id="hiddenDiv" style="position: absolute; left:calc(100vw + 100px)"></div>
    <!-- XY Coordinate Format Dialog ***** MOVE TO IDENTIFY??? ******-->
    <div id="xycoordsDialog" title="Change Display Format" style="display:none;width:210px;">
        <select id="xycoords_combo" size="4" onChange="xycoordsDialog.hide();setCookie('xycoords',document.getElementById('xycoords_combo').value);" style="position: absolute;bottom:0">
            <option value="mercator">WGS84 Web Mercator</option>
            <option value="geo">Decimal Degrees</option>
            <option value="dms" selected>Degrees, Minutes, Seconds</option>
            <option value="dm">Degrees, Decimal Minutes</option>
        </select>
    </div>
</body>

</html>