function printInit(){var e=createXMLhttpRequest(),i=app+"/PrintPdfWidget.xml?v="+ndisVer;e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var i=createXMLdoc(e);i.getElementsByTagName("disclaimer")[0]?prtDisclaimer=i.getElementsByTagName("disclaimer")[0].firstChild.nodeValue:alert("Missing tag, disclaimer, in "+app+"/PrintPdfWidget.xml file.","Data Error"),i.getElementsByTagName("helpvideo")[0]&&(document.getElementById("printVideo").innerHTML="<a target='help' href="+i.getElementsByTagName("helpvideo")[0].firstChild.nodeValue+">Click here to view help video.</a><br/><br/>")}else 404===e.status?(alert("Error: Missing PrintPdfWidget.aspx file in "+app+" directory.","Data Error"),hideLoading()):4===e.readyState&&500===e.status&&(alert("Missing PrintPdfWidget.aspx file. app="+app,"Data Error"),hideLoading())},e.open("GET",i,!0),e.send()}function printShow(){require(["esri/SpatialReference","esri/layers/GraphicsLayer","esri/graphic","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer","esri/geometry/Point","esri/layers/VectorTileLayer","esri/layers/OpenStreetMapLayer","dojo/dom","dojo/on","dojo/_base/array"],function(e,t,r,n,a,d,l,p,s,o,y){function g(e){"none"!==s.byId("printDiv").style.display&&require(["esri/layers/FeatureLayer"],function(i){D[e]++;var t=new i(map.getLayer(e).url,{opacity:Number(map.getLayer(e).opacity),id:e,visible:map.getLayer(e).visible});T.push(o(t,"error",u)),T.push(o(t,"load",m))})}function m(e){D[e.target.id]>5&&alert("While printing, the "+e.target.id+" service loaded sucessfully.","Note"),e.layer.refresh(),previewMap.addLayer(e.layer)}function u(e){D[e.target.id]<5?setTimeout(function(){g(e.target.id)},500):5==D[e.target.id]?(e.target.id.indexOf("Motor Vehicle")>-1||e.target.id.indexOf("Wildfire")>-1||e.target.id.indexOf("BLM")>-1?alert("While printing, the external map service that provides "+e.target.id+" is experiencing problems.  This issue is out of CPW control. We will continue trying to load it. We apologize for any inconvenience.","External (Non-CPW) Map Service Error"):alert("While printing, the "+e.target.id+" service is busy or not responding. We will continue trying to load it.","Data Error"),setTimeout(function(){g(e.target.id)},500)):setTimeout(function(){g(e.target.id)},1e3)}function c(e){if("none"!==s.byId("printDiv").style.display){D[e.id]++;for(var i=[],t=0;t<e.visibleLayers.length;t++)i.push(parseInt(e.visibleLayers[t]));var r=new a(e.url,{opacity:parseFloat(e.opacity),id:e.id,visible:e.visible});r.setVisibleLayers(i),i=null,T.push(o(r,"error",h)),T.push(o(r,"load",f)),printDialog.on("hide",L)}}function L(e){y.forEach(T,function(e){e.remove()}),T=[]}function h(e){D[e.target.id]<5?setTimeout(function(){c(map.getLayer(e.target.id))},500):5===D[e.target.id]?(e.target.id.indexOf("Motor Vehicle")>-1||e.target.id.indexOf("Wildfire")>-1||e.target.id.indexOf("BLM")>-1?alert("While printing, the external map service that provides "+e.target.id+" is experiencing problems.  This issue is out of CPW control. We will continue trying to load it. We apologize for any inconvenience.","External (Non-CPW) Map Service Error"):alert("While printing, the "+e.target.id+" service is busy or not responding. We will continue trying to load it.","Data Error"),setTimeout(function(){c(map.getLayer(e.target.id))},500)):setTimeout(function(){c(map.getLayer(e.target.id))},1e3)}function f(e){D[e.target.id]>5&&alert("While printing, the "+e.target.id+" service loaded sucessfully.","Note");var t,r=e.layer;if(!(r.url.indexOf("World_Street_Map")>-1)&&0!=r.id.indexOf("layer")){O++;var n=r.visibleLayers,a=r.layerInfos;for(j=0;j<r.visibleLayers.length;j++){k=r.visibleLayers[j];do{if(hideGroupSublayers.indexOf(a[k].name)>-1&&a[k].subLayerIds)for(t=0;t<a[k].subLayerIds.length;t++)if(-1==n.indexOf(a[k].subLayerIds[t])&&n.push(a[k].subLayerIds[t]),"Big Game GMU"==a[a[k].subLayerIds[t]+1].name){var d=1;"Bighorn GMU"==gmu?d=2:"Goat GMU"==gmu&&(d=3),-1==n.indexOf(a[k].subLayerIds[t]+d)&&n.push(a[k].subLayerIds[t]+d)}else-1==n.indexOf(a[k].subLayerIds[t]+1)&&n.push(a[k].subLayerIds[t]+1);k=a[k].parentLayerId}while(-1!=k)}var l=new Array(0,1,2,3,4,5,6,7,8,9);for(t=0;t<a.length;t++){-1!=n.indexOf(a[t].id)?a[t].visible=!0:-1==a[t].parentLayerId||a[t].subLayerIds?a[t].visible=!1:a[t].name.substr(a[t].name.length-3,3).indexOf("GMU")>-1?a[t].name==gmu?(-1==n.indexOf(t)&&(a[t].visible=!0),l.indexOf(parseInt(a[a[t].parentLayerId].name.substr(0,1)))>-1&&-1==n.indexOf(a[t].parentLayerId)&&(a[a[t].parentLayerId].visible=!0)):a[t].visible=!1:1==a[t].defaultVisibility&&-1===n.indexOf(a[t].parentLayerId)&&l.indexOf(parseInt(a[a[t].parentLayerId].name.substr(0,1)))>-1&&(a[a[t].parentLayerId].visible=!0);var p=n.indexOf(a[t].id);p>-1&&a[t].subLayerIds&&n.splice(p,1)}if(r.setVisibleLayers(n.sort(function(e,i){return e-i}),!1),r.refresh(),r.spatialReference=E,P.push(r),O==B){for(i=0;i<S.length;i++)for(j=0;j<P.length;j++)S[i]==P[j].id&&previewMap.addLayer(P[j]);P=null,S=null}}}var v,b,I,w,M,x,E=new e({wkid:wkid}),T=[],B=0,O=0,P=[],S=[],D=[];for(document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="",document.getElementById("printTitle").value="My Custom Map",document.getElementById("printSubTitle").value=s.byId("title").innerHTML,previewMap.removeAllLayers(),printDialog.show(),i=0;i<map.layerIds.length;i++)v=map.getLayer(map.layerIds[i]),"layer_osm"==map.layerIds[i]?(b=new p,b.id="layer_osm",previewMap.addLayer(b),b=null):v.attributionDataUrl&&v.attributionDataUrl.indexOf("OpenStreet")>-1?(b=new p,b.id="layer_osm",previewMap.addLayer(b),b=null):map.layerIds[i].indexOf("layer")>-1&&1==map.getLayer(map.layerIds[i]).visibleAtMapScale&&(map.getLayer(map.layerIds[i]).url.indexOf("MapServer")>-1?basemap=new n(map.getLayer(map.layerIds[i]).url,{id:"basemap",visible:!0}):(basemap=new l(map.getLayer(map.layerIds[i]).url,{id:"basemap",visible:!0}),basemap.setStyle(map.getLayer(map.layerIds[i]).url)),"reference"==v._basemapGalleryLayerType?basemap.id="reference":i>0&&(basemap.id="basemap"+i),basemap.spatialReference=map.spatialReference,basemap._basemapGalleryLayerType=v._basemapGalleryLayerType,basemap.refresh(),previewMap.addLayer(basemap),basemap=null);for(i=0;i<map.layerIds.length;i++)v=map.getLayer(map.layerIds[i]),0!=v.id.indexOf("layer")&&(v.attributionDataUrl&&v.attributionDataUrl.indexOf("OpenStreet")>-1||v.layerInfos&&v.visible&&(B++,S.push(v.id)));for(i=0;i<map.layerIds.length;i++)v=map.getLayer(map.layerIds[i]),v.layerInfos&&v.visible&&(D[v.id]=0,c(v));for(i=0;i<map.graphicsLayerIds.length;i++)if(map.graphicsLayerIds[i].indexOf("drawgraphics")>-1||map.graphicsLayerIds[i].indexOf("drawtextgraphics")>-1){for(I=new t,I.id=map.graphicsLayerIds[i],I.visible=!0,I.spatialReference=previewMap.spatialReference,w=map.getLayer(map.graphicsLayerIds[i]).graphics,M=0;M<w.length;M++)x=w[M].clone(),I.add(x);previewMap.addLayer(I),I=null,w=null}else map.graphicsLayerIds[i].indexOf("Wildfire")>-1&&(D[map.graphicsLayerIds[i]]=0,g(map.graphicsLayerIds[i]));if("undefined"!=typeof hb1298GraphicsLayer){for(I=new t,I.visible=!0,I.spatialReference=previewMap.spatialReference,w=map.getLayer(map.graphicsLayerIds[i]).graphics,M=0;M<hb1298GraphicsLayer.graphics.length;M++)x=w[M].clone(),I.add(x);previewMap.addLayer(I),I=null,w=null}previewMap.spatialReference=E;var W=new d(map.extent.xmax+(map.extent.xmin-map.extent.xmax)/2,map.extent.ymin+(map.extent.ymax-map.extent.ymin)/2,E);previewMap.centerAndZoom(W,map.getLevel()).then(function(){changePrintSize()}),W=null,E=null})}function changePrintSize(){require(["dojo/dom","dijit/registry"],function(e,i){if(previewMap&&previewMap.extent){document.getElementById("printMapLink").innerHTML="";document.getElementById("printPreviewMap");var t=e.byId("orient");index=t.selectedIndex;var r=t.options[index].value,n=e.byId("size");index=n.selectedIndex;var a=n.options[index].value,d=previewMap.extent.getCenter(),l=previewMap.getLevel();"Landscape"==r?"Letter ANSI A "==a?(previewMap.width=490,previewMap.height=348,i.byId("printPreviewMap").resize({w:490,h:348})):"Tabloid ANSI B "==a?(previewMap.width=544,previewMap.height=328,i.byId("printPreviewMap").resize({w:544,h:328})):"8.5 x 14 "==a&&(previewMap.width=506,previewMap.height=278,i.byId("printPreviewMap").resize({w:506,h:278})):"Letter ANSI A "==a?(previewMap.width=370,previewMap.height=468,i.byId("printPreviewMap").resize({w:370,h:468})):"Tabloid ANSI B "==a?(previewMap.width=343,previewMap.height=529,i.byId("printPreviewMap").resize({w:343,h:529})):"8.5 x 14 "==a&&(previewMap.width=296,previewMap.height=490,i.byId("printPreviewMap").resize({w:296,h:490})),l>-1&&previewMap.centerAndZoom(d,l),d=null}else alert("Please wait for page to load.")})}function grayOutLegend(e){require(["dojo/dom"],function(i){document.getElementById("printMapLink").innerHTML="","geopdf"!=e.value&&"pdf"!=e.value&&i.byId("printLegend")?i.byId("printLegendCB").style.display="none":i.byId("printLegendCB").style.display="inline-block","geotiff"!=e.value?document.getElementById("printInst").innerHTML="Disable pop-up blocker. Printout will open in a new tab.":document.getElementById("printInst").innerHTML=""})}function printMap(){require(["esri/tasks/PrintTask","esri/tasks/PrintTemplate","esri/tasks/PrintParameters","esri/urlUtils","esri/config","esri/graphic","esri/geometry/Point","esri/tasks/LegendLayer","esri/layers/GraphicsLayer","dojo/dom","dijit/registry"],function(e,i,t,r,n,a,d,l,p,s,o){function y(e){console.log("printing to "+e.url);try{window.open(e.url,"_blank")}catch(e){alert("Can't open printout in new window. Use link provided.")}for(c=0;c<L;c++)removeDrawItem();I&&(o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none"),document.getElementById("printMapLink").innerHTML="Opened map in a new tab.",I=!0}function g(e){o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none",alert("Error printing with basemap, "+mapBasemap+". Error Code: "+e,"Code Error",e),document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="";for(var i=0;i<L;i++)removeDrawItem();printDialog.hide()}function m(e){console.log("printing legend to "+e.url);try{window.open(e.url,"_blank")}catch(e){console.log("Can't open printout in new window. Use link provided.")}I&&(o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none"),document.getElementById("printLegendLink").innerHTML="Opened legend in a new tab.",I=!0}function u(e){o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none",document.getElementById("printLegendLink").innerHTML="",document.getElementById("printMapLink").innerHTML="",e.details?alert("Error printing the legend: "+e+e.details,"Code Error",e):alert("Error printing the legend: "+e,"Code Error",e),printDialog.hide()}var c,L;try{var h=document.getElementById("printLegend");o.byId("print_button").set("label","Creating..."),document.getElementById("printLoading").style.display="inline-block",document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="",L=0;var f,v=previewMap.getLayersVisibleAtScale(),b=[],I=!0;for(h&&document.getElementById("printLegend").checked&&(I=!1),c=1;c<v.length;c++)if(v[c].visible&&"topo"!=v[c].id&&"streets"!=v[c].id&&"hybrid"!=v[c].id){if(v[c].id.indexOf("drawgraphics")>0){if(v[c].graphics.length>1&&"point"==v[c].graphics[0].geometry.type&&!v[c].graphics[0].symbol.text){L++;var w=new d(v[c].graphics[0].geometry.x,v[c].graphics[0].geometry.y,map.spatialReference),M=new a(w),x=new p;x.id="drawgraphics"+drawGraphicsCounter,drawGraphicsCount.push(x.id),drawGraphicsCounter++,addLabel(M,v[c].graphics[1].symbol.text,x,"11pt")}continue}v[c].visibleLayers&&(f=new l,f.layerId=v[c].id,f.subLayerIds=v[c].visibleLayers,b.push(f),f=null)}var E=new e(printServiceUrl),T=new t,B=new i,k=s.byId("orient");s.byId("format");index=k.selectedIndex;var O=k.options[index].value,P=s.byId("size");index=P.selectedIndex;var S=P.options[index].value;if(B.exportOptions={dpi:96},B.layout=S+O,B.format="PDF",B.preserveScale=!1,B.showAttribution=!1,h&&document.getElementById("printLegend").checked?B.layoutOptions={titleText:document.getElementById("printTitle").value,authorText:prtDisclaimer,legendLayers:b,customTextElements:[{Subtitle:document.getElementById("printSubTitle").value}]}:B.layoutOptions={titleText:document.getElementById("printTitle").value,authorText:prtDisclaimer,legendLayers:[],customTextElements:[{Subtitle:document.getElementById("printSubTitle").value}]},T.map=previewMap,T.template=B,!fullExtent.contains(previewMap.extent))return alert("Printing is only allowed for Colorado.","Warning"),o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none",document.getElementById("printMapLink").innerHTML="",void(document.getElementById("printLegendLink").innerHTML="");if(E.execute(T,y,g),h&&document.getElementById("printLegend").checked){var D=new e(printServiceUrl),W=new t,C=new i;C.exportOptions={dpi:96},C.layout="Legend Letter "+O,C.format="PDF",C.layoutOptions={titleText:document.getElementById("printTitle").value,authorText:prtDisclaimer,legendLayers:b,customTextElements:[{Subtitle:document.getElementById("printSubTitle").value},{Legend:b}]},W.map=previewMap,W.template=C,D.execute(W,m,u)}}catch(e){for(c=0;c<L;c++)removeDrawItem();alert("Error while printing: "+e.message,"Code Error",e),o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none"}})}var prtDisclaimer="";