define("agsjs/dijit/TOC",["dojo/_base/declare","dojo/has","dojo/aspect","dojo/_base/lang","dojo/_base/array","dojo/dom-construct","dojo/dom-class","dojo/dom-style","dojo/dom-attr","dijit/_Widget","dijit/_Templated","dojo/Evented","dojox/gfx","dojo/fx","dojo/fx/Toggler","dojox/mobile/CheckBox","dojox/mobile/RadioButton","dojox/mobile/ToggleButton","esri/symbols/jsonUtils","esri/geometry/scaleUtils","esri/config","esri/layers/ArcGISDynamicMapServiceLayer","esri/layers/ArcGISTiledMapServiceLayer","dojo/_base/sniff"],function(declare,has,aspect,lang,array,domConstruct,domClass,domStyle,domAttr,_Widget,_Templated,Evented,gfx,coreFx,Toggler,CheckBox,RadioButton,ToggleButton,jsonUtils,scaleUtils,esriConfig,ArcGISDynamicMapServiceLayer,ArcGISTiledMapServiceLayer){var _TOCNode=declare([_Widget,_Templated],{templateString:'<div class="agsjsTOCNode">'+'<div data-dojo-attach-point="rowNode" data-dojo-attach-event="onclick:_onClick">'+'<span data-dojo-attach-point="contentNode" class="agsjsTOCContent">'+'<span data-dojo-attach-point="spacerNode" style="display: none;width:16px !important;"></span>'+'<span data-dojo-attach-point="checkContainerNode"></span>'+'<img src="${_blankGif}" alt="" data-dojo-attach-point="iconNode" />'+'<span data-dojo-attach-point="labelNode">'+'</span></span></div>'+'<div data-dojo-attach-point="containerNode" style="display: none;"> </div></div>',rootLayer:null,serviceLayer:null,legend:null,rootLayerTOC:null,data:null,_childTOCNodes:[],hiddenIds:[],constructor:function(params,srcNodeRef){lang.mixin(this,params);},postCreate:function(){domStyle.set(this.rowNode,'paddingLeft',''+this.rootLayerTOC.tocWidget.indentSize*this.rootLayerTOC._currentIndent+'px');this.data=this.legend||this.serviceLayer||this.rootLayer;this.blank=this.iconNode.src;if(this.hiddenIds[this.rootLayerTOC.config.title]==null)this.hiddenIds[this.rootLayerTOC.config.title]=new Array();var hiddenLayer=false;if(this.rootLayerTOC.config.hideGroupSublayers){if(this.data._parentLayerInfo!=null&&this.data._parentLayerInfo.name!=null&&this.rootLayerTOC.config.hideGroupSublayers.indexOf(this.data._parentLayerInfo.name)>-1){hiddenLayer=true;domStyle.set(this.contentNode,'display','none');if(this.serviceLayer.subLayerIds==null){this.hiddenIds[this.rootLayerTOC.config.title].push(this.serviceLayer.id);}}
else if(this.data._parentLayerInfo!=null&&this.data._parentLayerInfo._parentLayerInfo!=null&&this.data._parentLayerInfo._parentLayerInfo.name!=null&&this.rootLayerTOC.config.hideGroupSublayers.indexOf(this.data._parentLayerInfo._parentLayerInfo.name)>-1){hiddenLayer=true;domStyle.set(this.contentNode,'display','none');if(this.serviceLayer.subLayerIds==null){this.hiddenIds[this.rootLayerTOC.config.title].push(this.serviceLayer.id);this.hiddenIds[this.rootLayerTOC.config.title].push(this.data._parentLayerInfo.id);this.serviceLayer.minScale=this.serviceLayer._parentLayerInfo.minScale;this.serviceLayer.maxScale=this.serviceLayer._parentLayerInfo.maxScale;}}
else if(this.data._parentLayerInfo!=null&&this.data._parentLayerInfo._parentLayerInfo!=null&&this.data._parentLayerInfo._parentLayerInfo._parentLayerInfo!=null&&this.data._parentLayerInfo._parentLayerInfo._parentLayerInfo.name!=null&&this.rootLayerTOC.config.hideGroupSublayers.indexOf(this.data._parentLayerInfo._parentLayerInfo._parentLayerInfo.name)>-1){hiddenLayer=true;domStyle.set(this.contentNode,'display','none');if(this.serviceLayer.subLayerIds==null){this.hiddenIds[this.rootLayerTOC.config.title].push(this.serviceLayer.id);this.hiddenIds[this.rootLayerTOC.config.title].push(this.data._parentLayerInfo._parentLayerInfo.id);this.serviceLayer.minScale=this.serviceLayer._parentLayerInfo._parentLayerInfo.minScale;this.serviceLayer.maxScale=this.serviceLayer._parentLayerInfo._parentLayerInfo.maxScale;}}}
if(this.legend&&!this.rootLayerTOC.config.noLegend){this._createLegendNode(this.legend);}else if(this.serviceLayer){this._createServiceLayerNode(this.serviceLayer);}else if(this.rootLayer){this._createRootLayerNode(this.rootLayer);}
if(this.containerNode&&Toggler){this.toggler=new Toggler({node:this.containerNode,showFunc:coreFx.wipeIn,hideFunc:coreFx.wipeOut})}
if(!this._noCheckNode){var chk;if(!hiddenLayer&&(this.data.parentLayerId>-1&&this.rootLayerTOC.config.radioLayers.indexOf(this.data._parentLayerInfo.name)>-1)||(this.data.parentLayerId==-1&&this.rootLayerTOC.config.radioLayers.indexOf(this.rootLayer.id)>-1)){var grpName;if(this.data.parentLayerId>-1)
grpName=this.rootLayerTOC.config.title.replace(/ /g,"_")+"_"+this.data._parentLayerInfo.name.replace(/ /g,"_");else
grpName=this.rootLayerTOC.config.title.replace(/ /g,"_");chk=document.createElement("INPUT");chk.setAttribute("type","radio");chk.setAttribute("name",grpName);chk.setAttribute("id","Radio");chk.setAttribute("class","radioButton");chk.checked=this.data.visible;this.contentNode.childNodes[1].appendChild(chk);this.checkNode=chk;if(!this.data._legends||(this.data._legends&&this.data._legends.length==-1))
domStyle.set(this.iconNode,'visibility','hidden');}
else{if(this.rootLayerTOC.config.openSubLayers.indexOf(this.data.name)>-1)
this.data.visible=true;chk=document.createElement("INPUT");chk.setAttribute("type","checkbox");chk.setAttribute("class","checkBoxButton");chk.checked=this.data.visible;this.contentNode.childNodes[1].appendChild(chk);this.checkNode=chk;if(!this.rootLayerTOC.config.noLegend&&this.serviceLayer&&this.serviceLayer._legends&&this.serviceLayer._legends.length==1){domStyle.set(this.checkContainerNode,"float","left");domStyle.set(this.checkContainerNode,"padding","0 0 0 0");}
if(!this.rootLayerTOC.config.noLegend&&this.serviceLayer&&this.serviceLayer._legends&&this.serviceLayer._legends.length>1){domStyle.set(this.iconNode,'visibility','hidden');}
if(this.serviceLayer&&this.serviceLayer.subLayerIds){for(var i=0;i<this.serviceLayer.subLayerIds.length;i++){if(this.hiddenIds[this.rootLayer.id].indexOf(this.serviceLayer.subLayerIds[i])>-1){domStyle.set(this.iconNode,'visibility','hidden');break;}}}}
if(hiddenLayer&&this.iconNode&&this.iconNode.src.indexOf("blank.gif")==-1){domStyle.set(this.contentNode,'display','block');domStyle.set(this.checkContainerNode,'display','none');this.checkNode.checked=true;}}
var showChildren=this.data.visible;if(this.data._subLayerInfos){var noneVisible=true;array.every(this.data._subLayerInfos,function(info){if(info.visible){noneVisible=false;return false;}
return true;});if(noneVisible)
showChildren=false;}
if(this.data.collapsed)
showChildren=false;if(this.iconNode&&this.iconNode.src==this.blank){domClass.add(this.iconNode,'dijitTreeExpando');domClass.add(this.iconNode,showChildren?'dijitTreeExpandoOpened':'dijitTreeExpandoClosed');}
if(this.iconNode){domClass.add(this.iconNode,'agsjsTOCIcon');}
else{domStyle.set(this.spacerNode,"display","inline-block");}
if(this.containerNode){domStyle.set(this.containerNode,'display',showChildren?'block':'none');}
this.domNode.id='TOCNode_'+this.rootLayer.id+(this.serviceLayer?'_'+this.serviceLayer.id:'')+(this.legend?'_'+this.legend.id:'');},_createRootLayerNode:function(rootLayer){domClass.add(this.rowNode,'agsjsTOCRootLayer');domClass.add(this.labelNode,'agsjsTOCRootLayerLabel');var title=this.rootLayerTOC.config.title;if(title===''){esri.hide(this.rowNode);rootLayer.show();this.rootLayerTOC._currentIndent--;}else if(title===undefined){if(rootLayer.name){title=rootLayer.name;}else{var start=rootLayer.url.toLowerCase().indexOf('/rest/services/');var end=rootLayer.url.toLowerCase().indexOf('/mapserver',start);title=rootLayer.url.substring(start+15,end);}}
rootLayer.collapsed=this.rootLayerTOC.config.collapsed;if(this.rootLayerTOC.config.slider){this.sliderNode=domConstruct.create('div',{'class':'agsjsTOCSlider'},this.rowNode,'last');var me=this;require(["dojox/mobile/Slider"],function(Slider){me.slider=new Slider({step:5,min:0,max:100,orientation:"H",intermediateChanges:true,value:rootLayer.opacity*100,onChange:function(value){rootLayer.setOpacity(value/100);rootLayer.refresh();},style:"float:right;margin:12px;height:5px;width:100px;"});me.slider.placeAt(me.sliderNode);rootLayer.on('opacity-change',function(evt){me.slider.set("value",evt.opacity*100);});});}
if(rootLayer._tocInfos){this._createChildrenNodes(rootLayer._tocInfos,'serviceLayer');}else if(rootLayer.renderer&&!this.rootLayerTOC.config.noLegend){var r=rootLayer.renderer;if(r.infos){var legs=r.infos;if(r.defaultSymbol&&legs.length>0&&legs[0].label!='[all other values]'){legs.unshift({label:'[all other values]',symbol:r.defaultSymbol})}
var af=r.attributeField+(r.normalizationField?'/'+r.normalizationField:'');af+=(r.attributeField2?'/'+r.attributeField2:'')+(r.attributeField3?'/'+r.attributeField3:'');var anode=domConstruct.create('div',{},this.containerNode);domStyle.set(anode,'paddingLeft',''+this.rootLayerTOC.tocWidget.indentSize*(this.rootLayerTOC._currentIndent)+'px');anode.innerHTML=af;this._createChildrenNodes(legs,'legend');}else{this._setIconNode(rootLayer.renderer,this.iconNode,this);domConstruct.destroy(this.containerNode);this.containerNode=null;}}else{domStyle.set(this.iconNode,'visibility','hidden');}
this.labelNode.innerHTML=title;domAttr.set(this.rowNode,'title',title);},_createServiceLayerNode:function(serviceLayer){this.labelNode.innerHTML=serviceLayer.name;if(serviceLayer._subLayerInfos){domClass.add(this.rowNode,'agsjsTOCGroupLayer');domClass.add(this.labelNode,'agsjsTOCGroupLayerLabel');this._createChildrenNodes(serviceLayer._subLayerInfos,'serviceLayer');}else{domClass.add(this.rowNode,'agsjsTOCServiceLayer');domClass.add(this.labelNode,'agsjsTOCServiceLayerLabel');if(this.rootLayer.tileInfo){this._noCheckNode=true;}
if(!this.rootLayerTOC.config.noLegend&&serviceLayer._legends){if(serviceLayer._legends.length==1){this.iconNode.src=this._getLegendIconUrl(serviceLayer._legends[0]);domConstruct.destroy(this.containerNode);this.containerNode=null;}else{this._createChildrenNodes(serviceLayer._legends,'legend');}}else{domConstruct.destroy(this.iconNode);this.iconNode=null;domConstruct.destroy(this.containerNode);this.containerNode=null;}}},_createLegendNode:function(rendLeg){this._noCheckNode=true;domConstruct.destroy(this.containerNode);domClass.add(this.labelNode,'agsjsTOCLegendLabel');this._setIconNode(rendLeg,this.iconNode,this);var label=rendLeg.label;if(rendLeg.label===undefined){if(rendLeg.value!==undefined){label=rendLeg.value;}
if(rendLeg.maxValue!==undefined){label=''+rendLeg.minValue+' - '+rendLeg.maxValue;}}
this.labelNode.appendChild(document.createTextNode(label));},_setIconNode:function(rendLeg,iconNode,tocNode){var src=this._getLegendIconUrl(rendLeg);if(!src){if(rendLeg.symbol){var w=this.rootLayerTOC.tocWidget.swatchSize[0];var h=this.rootLayerTOC.tocWidget.swatchSize[1];if(rendLeg.symbol.width&&rendLeg.symbol.height){w=rendLeg.symbol.width;h=rendLeg.symbol.height;}
var node=domConstruct.create('span',{});domStyle.set(node,{'width':w+'px','height':h+'px','display':'inline-block'});domConstruct.place(node,iconNode,'replace');tocNode.iconNode=node;var descriptors=jsonUtils.getShapeDescriptors(rendLeg.symbol);var mySurface=gfx.createSurface(node,w,h);if(descriptors){if(has('ie')){window.setTimeout(lang.hitch(this,'_createSymbol',mySurface,descriptors,w,h),500);}else{this._createSymbol(mySurface,descriptors,w,h);}}}else{if(console)
console.log('no symbol in renderer');}}else{iconNode.src=src;if(rendLeg.symbol&&rendLeg.symbol.width&&rendLeg.symbol.height){iconNode.style.width=rendLeg.symbol.width;iconNode.style.height=rendLeg.symbol.height;}}},_createSymbol:function(mySurface,descriptors,w,h){var shape=mySurface.createShape(descriptors.defaultShape);if(descriptors.fill){shape.setFill(descriptors.fill);}
if(descriptors.stroke){shape.setStroke(descriptors.stroke);}
shape.applyTransform({dx:w/2,dy:h/2});},_getLegendIconUrl:function(legend){var src=legend.url;if(src!=null&&src.indexOf('data')==-1){if(!has('ie')&&legend.imageData&&legend.imageData.length>0){src="data:image/png;base64,"+legend.imageData;}else{if(src.indexOf('http')!==0){src=this.rootLayer.url+'/'+this.serviceLayer.id+'/images/'+src;}
if(this.rootLayer.credential&&this.rootLayer.credential.token){src=src+"?token="+this.rootLayer.credential.token;}else if(esriConfig.defaults.io.alwaysUseProxy){src=esriConfig.defaults.io.proxyUrl+"?"+src;}}}
return src;},_createChildrenNodes:function(chdn,type){if(this.rootLayer.id=="Motor Vehicle Use Map")
{var MVUMimg=domConstruct.create("img",{src:"assets/images/USFS_MVUM_legend_small.png"},this.containerNode);domStyle.set(MVUMimg,{'width':325+'px','height':227+'px','display':'inline-block'});return;}
this.rootLayerTOC._currentIndent++;var c=[];for(var i=0,n=chdn.length;i<n;i++){var chd=chdn[i];var params={rootLayerTOC:this.rootLayerTOC,rootLayer:this.rootLayer,serviceLayer:this.serviceLayer,legend:this.legend};params[type]=chd;params.data=chd;if(type=='legend'){chd.id='legend'+i;}
var node=new _TOCNode(params);node.placeAt(this.containerNode);c.push(node);}
this._childTOCNodes=c;this.rootLayerTOC._currentIndent--;},_toggleContainer:function(o){if(this.iconNode&&(domClass.contains(this.iconNode,'dijitTreeExpandoClosed')||domClass.contains(this.iconNode,'dijitTreeExpandoOpened'))){if(o){domClass.remove(this.iconNode,'dijitTreeExpandoClosed');domClass.add(this.iconNode,'dijitTreeExpandoOpened');}else if(o===false){domClass.remove(this.iconNode,'dijitTreeExpandoOpened');domClass.add(this.iconNode,'dijitTreeExpandoClosed');}else{domClass.toggle(this.iconNode,'dijitTreeExpandoClosed');domClass.toggle(this.iconNode,'dijitTreeExpandoOpened');}
if(domClass.contains(this.iconNode,'dijitTreeExpandoOpened')){if(this.toggler){this.toggler.show();}else{esri.show(this.containerNode);}}else{if(this.toggler){this.toggler.hide();}else{esri.hide(this.containerNode);}}
if(this.rootLayer&&!this.serviceLayer&&!this.legend){this.rootLayerTOC.config.collapsed=domClass.contains(this.iconNode,'dijitTreeExpandoClosed');}}},expand:function(){this._toggleContainer(true);},collapse:function(){this._toggleContainer(false);},show:function(){esri.show(this.domNode);},hide:function(){esri.hide(this.domNode);},_adjustToState:function(){if(this.checkNode&&this.checkNode.disabled==false){var checked=this.legend?this.legend.visible:this.serviceLayer?this.serviceLayer.visible:this.rootLayer?this.rootLayer.visible:false;if(this.checkNode.set){this.checkNode.set('checked',checked);}else{this.checkNode.checked=checked;}}
if(this.serviceLayer){var scale=parseInt(scaleUtils.getScale(this.rootLayerTOC.tocWidget.map));var outScale=(this.serviceLayer.maxScale!=0&&scale<parseInt(this.serviceLayer.maxScale))||(this.serviceLayer.minScale!=0&&scale>parseInt(this.serviceLayer.minScale));if(outScale){domClass.add(this.domNode,'agsjsTOCOutOfScale');}else{domClass.remove(this.domNode,'agsjsTOCOutOfScale');}
if(this.checkNode){if(this.checkNode.set){this.checkNode.set('disabled',outScale);}else{this.checkNode.disabled=outScale;}}
if(outScale){domStyle.set(this.labelNode,'color','gray');}
else{domStyle.set(this.labelNode,'color','');}
if(outScale&&this.hiddenIds[this.rootLayerTOC.config.title].indexOf(this.serviceLayer.id)>-1){domStyle.set(this.rowNode,"display","none");}
else if(this.hiddenIds[this.rootLayerTOC.config.title].indexOf(this.serviceLayer.id)>-1){domStyle.set(this.rowNode,"display","block");}
if(!outScale&&(this.labelNode.innerHTML=="Big Game GMU"||this.labelNode.innerHTML=="Goat GMU"||this.labelNode.innerHTML=="Bighorn GMU")){if(gmu==this.labelNode.innerHTML)
domStyle.set(this.rowNode,"display","block");else domStyle.set(this.rowNode,"display","none");}}
if(this._childTOCNodes.length>0){array.forEach(this._childTOCNodes,function(child){child._adjustToState();});}},_onClick:function(evt){var t=evt.target;var lay;if(t==this.checkNode||dijit.getEnclosingWidget(t)==this.checkNode){if(this.serviceLayer){if(this.checkNode.id.indexOf("Radio")>-1){var layerInfos=this.rootLayer.layerInfos;var i;if(this.serviceLayer.parentLayerId==-1){for(i=0;i<layerInfos.length;i++){if((layerInfos[i].name!=this.serviceLayer.name)&&(layerInfos[i].parentLayerId==-1))
layerInfos[i].visible=false;}}
else{for(i=0;i<layerInfos.length;i++){if((layerInfos[i].name!=this.serviceLayer.name)&&(layerInfos[i].parentLayerId!=-1)&&(this.rootLayerTOC.config.radioLayers.indexOf(layerInfos[layerInfos[i].parentLayerId].name))>-1)
layerInfos[i].visible=false;}}}
if(this.rootLayer.id=="Game Species"&&this.serviceLayer.parentLayerId==-1){if(this.serviceLayer.name=="Bighorn Sheep")gmu="Bighorn GMU";else if(this.serviceLayer.name=="Mountain Goat")gmu="Goat GMU";else gmu="Big Game GMU";for(var k=0;k<this.rootLayerTOC.tocWidget._rootLayerTOCs.length;k++)
if(this.rootLayerTOC.tocWidget._rootLayerTOCs[k].config.title=="Hunter Reference"){this.rootLayerTOC.tocWidget._rootLayerTOCs[k].rootLayer.setVisibleLayers(this.rootLayerTOC.tocWidget._rootLayerTOCs[k]._rootLayerNode._getVisibleLayers(),true);this.rootLayerTOC.tocWidget._rootLayerTOCs[k]._rootLayerNode.rootLayerTOC._refreshLayer()
this.rootLayerTOC.tocWidget._rootLayerTOCs[k]._rootLayerNode.rootLayerTOC._adjustToState();break;}}
this.serviceLayer.visible=this.checkNode&&this.checkNode.checked;this.rootLayer.setVisibleLayers(this._getVisibleLayers(),true);this.rootLayerTOC._refreshLayer();}else if(this.rootLayer){this.rootLayer.setVisibleLayers(this._getVisibleLayers(),true);this.rootLayer.setVisibility(this.checkNode&&this.checkNode.checked);}
if(this.rootLayerTOC.config.autoToggle!==false){if(this.checkNode.id.indexOf("Radio")>-1){this._setRadioToggle(this.rootLayerTOC._rootLayerNode._childTOCNodes,this.serviceLayer.parentLayerId);}
this._toggleContainer(this.checkNode&&this.checkNode.checked);}
this.rootLayerTOC._adjustToState();}else if(t==this.iconNode){this._toggleContainer();}},_setRadioToggle:function(childNodes,parentId){array.forEach(childNodes,function(node){if(node.serviceLayer.parentLayerId==parentId){var o=(node.checkNode&&node.checkNode.checked);if(domClass.contains(node.iconNode,'dijitTreeExpandoClosed')||domClass.contains(node.iconNode,'dijitTreeExpandoOpened')){if(o){domClass.remove(node.iconNode,'dijitTreeExpandoClosed');domClass.add(node.iconNode,'dijitTreeExpandoOpened');}else if(o===false){domClass.remove(node.iconNode,'dijitTreeExpandoOpened');domClass.add(node.iconNode,'dijitTreeExpandoClosed');}else{domClass.toggle(node.iconNode,'dijitTreeExpandoClosed');domClass.toggle(node.iconNode,'dijitTreeExpandoOpened');}
if(domClass.contains(node.iconNode,'dijitTreeExpandoOpened')){if(node.toggler){node.toggler.show();}else{esri.show(node.containerNode);}}else{if(node.toggler){node.toggler.hide();}else{esri.hide(node.containerNode);}}
if(node.rootLayer&&!node.serviceLayer&&!node.legend){node.rootLayerTOC.config.collapsed=domClass.contains(node.iconNode,'dijitTreeExpandoClosed');}}}
if(node._childTOCNodes)this._setRadioToggle(node._childTOCNodes,parentId);},this);},_setSubLayerVisibilitiesFromGroup:function(lay){if(lay._subLayerInfos&&lay._subLayerInfos.length>0){array.forEach(lay._subLayerInfos,function(info){info.visible=lay.visible;if(info._subLayerInfos&&info._subLayerInfos.length>0){this._setSubLayerVisibilitiesFromGroup(info);}},this);}},_getVisibleLayers:function(){var vis=[];var layerInfo=this.rootLayer.layerInfos;var scale=parseInt(scaleUtils.getScale(this.rootLayerTOC.tocWidget.map));for(var m=0;m<layerInfo.length;m++){if(layerInfo[m]._subLayerInfos==null&&(layerInfo[m].visible||this.hiddenIds[this.rootLayerTOC.config.title].indexOf(layerInfo[m].id)>-1)){var parentsVis=true;if((layerInfo[m].maxScale!=0&&scale<layerInfo[m].maxScale)||(layerInfo[m].minScale!=0&&scale>layerInfo[m].minScale)){continue;}
if(layerInfo[m].parentLayerId>-1){var parent=layerInfo[m];do{parent=layerInfo[parent.parentLayerId];if(!parent.visible){parentsVis=false;break;}}while(parent.parentLayerId>-1);if(parentsVis){if(layerInfo[m].name=="Big Game GMU"||layerInfo[m].name=="Goat GMU"||layerInfo[m].name=="Bighorn GMU"){if(gmu==layerInfo[m].name)
vis.push(layerInfo[m].id);else continue;}
else
vis.push(layerInfo[m].id);}}
else
vis.push(layerInfo[m].id);}}
if(vis.length===0){vis.push(-1);}
return vis;},_findTOCNode:function(layerId){if(this.serviceLayer&&this.serviceLayer.id==layerId){return this;}
if(this._childTOCNodes.length>0){var n=null;for(var i=0,c=this._childTOCNodes.length;i<c;i++){n=this._childTOCNodes[i]._findTOCNode(layerId);if(n)return n;}}
return null;}});var _RootLayerTOC=declare([_Widget],{_currentIndent:0,rootLayer:null,tocWidget:null,constructor:function(params,srcNodeRef){this.config=params.config||{};this.rootLayer=params.config.layer;this.tocWidget=params.tocWidget;},postCreate:function(){if((this.rootLayer instanceof(ArcGISDynamicMapServiceLayer)||this.rootLayer instanceof(ArcGISTiledMapServiceLayer))){if(this._legendResponse){this._createRootLayerTOC();}else{this._getLegendInfo();}}else{this._createRootLayerTOC();}},_getLegendInfo:function(){var url='';if(this.rootLayer.version>=10.01){url=this.rootLayer.url+'/legend';}else{url='http://www.arcgis.com/sharing/tools/legend';var i=this.rootLayer.url.toLowerCase().indexOf('/rest/');var soap=this.rootLayer.url.substring(0,i)+this.rootLayer.url.substring(i+5);url=url+'?soapUrl='+escape(soap);}
var handle=esri.request({url:url,content:{f:"json"},callbackParamName:'callback',handleAs:'json',load:lang.hitch(this,this._processLegendInfo),error:lang.hitch(this,this._processLegendError)});},_processLegendError:function(err){this._createRootLayerTOC();},_processLegendInfo:function(json){this._legendResponse=json;var layer=this.rootLayer;if(!layer._tocInfos){var layerLookup={};array.forEach(layer.layerInfos,function(layerInfo){layerLookup[''+layerInfo.id]=layerInfo;layerInfo.visible=layerInfo.defaultVisibility;if(layer.visibleLayers&&!layerInfo.subLayerIds){if(array.indexOf(layer.visibleLayers,layerInfo.id)==-1){layerInfo.visible=false;}else{layerInfo.visible=true;}}});if(json.layers){array.forEach(json.layers,function(legInfo){var layerInfo=layerLookup[''+legInfo.layerId];if(layerInfo&&legInfo.legend){layerInfo._legends=legInfo.legend;}});}
array.forEach(layer.layerInfos,function(layerInfo){if(layerInfo.subLayerIds){var subLayerInfos=[];array.forEach(layerInfo.subLayerIds,function(id,i){subLayerInfos[i]=layerLookup[id];subLayerInfos[i]._parentLayerInfo=layerInfo;});layerInfo._subLayerInfos=subLayerInfos;}});var tocInfos=[];array.forEach(layer.layerInfos,function(layerInfo){if(layerInfo.parentLayerId==-1){tocInfos.push(layerInfo);}});layer._tocInfos=tocInfos;}
this._createRootLayerTOC();},_createRootLayerTOC:function(){if(this.rootLayer.loaded){this._rootLayerNode=new _TOCNode({rootLayerTOC:this,rootLayer:this.rootLayer});this._rootLayerNode.placeAt(this.domNode);this._visHandler=this.rootLayer.on("visibility-change",lang.hitch(this,this._adjustToState));if(this.rootLayer instanceof(ArcGISDynamicMapServiceLayer)){this._visLayerHandler=aspect.after(this.rootLayer,"setVisibleLayers",lang.hitch(this,this._onSetVisibleLayers),true);}
this._adjustToState();this._loaded=true;this.onLoad();}else{this.rootLayer.on('load',lang.hitch(this,this._createRootLayerTOC));}},onLoad:function(){},_refreshLayer:function(){var rootLayer=this.rootLayer;var timeout=this.tocWidget.refreshDelay;if(this._refreshTimer){window.clearTimeout(this._refreshTimer);this._refreshTimer=null;}
this._refreshTimer=window.setTimeout(function(){rootLayer.setVisibleLayers(rootLayer.visibleLayers);},timeout);},_onSetVisibleLayers:function(visLayers,doNotRefresh){if(!doNotRefresh){var childNodes=this._rootLayerNode._childTOCNodes;var radioLayers=this.config.radioLayers;var tocNode=this._rootLayerNode;array.forEach(this.rootLayer.layerInfos,function(layerInfo){var scale=map.getScale();var outScale=(layerInfo.maxScale!=0&&scale<parseInt(layerInfo.maxScale))||(layerInfo.minScale!=0&&scale>parseInt(layerInfo.minScale));if(array.indexOf(visLayers,layerInfo.id)!=-1){layerInfo.visible=true;}else if(!layerInfo._subLayerInfos&&!outScale&&array.indexOf(visLayers,layerInfo.parentLayerId)!=-1){layerInfo.visible=false;}});this._adjustToState();}},_adjustToState:function(){this._rootLayerNode._adjustToState();},_adjustToState2:function(){if(this._rootLayerNode&&this._rootLayerNode.checkNode.checked){this.rootLayer.setVisibleLayers(this._rootLayerNode._getVisibleLayers(),true);this._rootLayerNode._adjustToState();this._refreshLayer();}
else if(this._rootLayerNode)
this._rootLayerNode._adjustToState();},destroy:function(){if(this._visHandler){this._visHandler.remove();this._visHandler=null;}
if(this._visLayerHandler){this._visLayerHandler.remove();this._visLayerHandler=null;}}});var TOC=declare("agsjs.dijit.TOC",[_Widget,Evented],{indentSize:25,swatchSize:[30,30],refreshDelay:500,layerInfos:null,constructor:function(params,srcNodeRef){params=params||{};if(!params.map){throw new Error('no map defined in params for TOC');}
this.layerInfos=params.layerInfos;lang.mixin(this,params);},postCreate:function(){this._createTOC();},onLoad:function(){},_createTOC:function(){domConstruct.empty(this.domNode);this._rootLayerTOCs=[];for(var i=0,c=this.layerInfos.length;i<c;i++){var info=this.layerInfos[i];var rootLayerTOC=new _RootLayerTOC({config:info,tocWidget:this});this._rootLayerTOCs.push(rootLayerTOC);this._checkLoadHandler=rootLayerTOC.on('load',lang.hitch(this,'_checkLoad'));rootLayerTOC.placeAt(this.domNode);this._checkLoad();}
if(!this._zoomHandler){this._zoomHandler=this.map.on('zoom-end',lang.hitch(this,"_adjustToState"));}
if(!this._loadHandler){this._loadHandler=this.on('load',function(){window.setTimeout(lang.hitch(this,"_adjustToState"),200);});}},_checkLoad:function(){var loaded=true;array.every(this._rootLayerTOCs,function(widget){if(!widget._loaded){loaded=false;return false;}
return true;});if(loaded){this.onLoad();this.emit('load');}},_adjustToState:function(){array.forEach(this._rootLayerTOCs,function(widget){widget._adjustToState2();});},refresh:function(){this._createTOC();},destroy:function(){this._zoomHandler.remove();this._zoomHandler=null;this._loadHandler.remove();this._loadHandler=null;this._checkLoadHandler.remove();this._checkLoadHandler=null;},findTOCNode:function(layer,serviceLayerId){var w;array.every(this._rootLayerTOCs,function(widget){if(widget.rootLayer==layer){w=widget;return false;}
return true;});if(serviceLayerId!==null&&serviceLayerId!==undefined&&w.rootLayer instanceof(ArcGISDynamicMapServiceLayer)){return w._rootLayerNode._findTOCNode(serviceLayerId);}else if(w){return w._rootLayerNode;}
return null;}});return TOC;});