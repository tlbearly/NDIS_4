var toolbar;var drawGraphicsCount=[],lenGraphicsCount=[];var drawGraphicsCounter=0,lenGraphicsCounter=0;var drawGraphicsLayer,lenGraphicsLayer;var labelPoint;var wayPtMaxScale=4622324;var wayPointHelp=null;function wayPointInit(){require(["dojo/_base/window","javascript/HelpWin"],function(win,HelpWin){wayPointHelp=new HelpWin({label:"Way Point Help",content:'Allows clicking on the map to add way points with a label and description. Way points '+'will only show up when you are zoomed in. If needed, the map will automatically zoom in to let you see '+'the new way point you are adding. Once a way point is added, you may click on it to see the description, '+'to edit the label or description, or to delete it. In Bookmark (on the main menu) you can save your way '+'points in your browser\'s cache. Bookmark also allows uploading and downloading kml or kmz files with the '+'current way points and map extent. These can be created in google maps.'+'<br/><br/>'});win.body().appendChild(wayPointHelp.domNode);wayPointHelp.startup();});}
function safeInput(txtBox){var ch=["~","|",";","#","^","%","\\","&"];var msg="",count=0;for(var i=0;i<ch.length;i++){if(txtBox.value.indexOf(ch[i])>-1){switch(ch[i]){case"&":txtBox.value=txtBox.value.replace(/&/g,"and");break;case"~":txtBox.value=txtBox.value.replace(/~/g,"");break;case"|":txtBox.value=txtBox.value.replace(/\|/g,"");break;case";":txtBox.value=txtBox.value.replace(/;/g,"");break;case"#":txtBox.value=txtBox.value.replace(/#/g,"");break;case"^":txtBox.value=txtBox.value.replace(/\^/g,"");break;case"%":txtBox.value=txtBox.value.replace(/%/g,"");break;case"\\":txtBox.value=txtBox.value.replace(/\\/g,"");break;}
msg+=ch[i]+" ";count++;}}
if(count>1)
alert(msg+"are not allowed. They were removed.","Note");else if(count==1)
alert(msg+"is not allowed. It was removed.","Note");if(count==0)return true;else return false;}
function resizeTextBox(txtBox){if(!txtBox)return;txtBox.style.height='auto';txtBox.style.height=txtBox.scrollHeight+'px';hideLoading();}
function addPoint(geometry,label,desc,symbol){require(["dojo/dom","esri/layers/GraphicsLayer","esri/graphic","esri/symbols/SimpleMarkerSymbol","dojo/_base/Color","esri/symbols/Font","esri/symbols/TextSymbol","dojox/mobile/ExpandingTextArea","esri/InfoTemplate"],function(dom,GraphicsLayer,Graphic,SimpleMarkerSymbol,Color,Font,TextSymbol,ExpandingTextArea,InfoTemplate){label=label.replace(/~/g," ");desc=desc.replace(/~/g," ");drawGraphicsLayer=new GraphicsLayer();drawGraphicsLayer.id="drawgraphics"+drawGraphicsCounter;var g=new Graphic(geometry,symbol);drawGraphicsLayer.add(g);var symbol2=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,40,null,new Color([0,0,255,0.05]));g=new Graphic(geometry,symbol2);drawGraphicsLayer.add(g);var font=new Font("9pt",Font.STYLE_NORMAL,Font.VARIANT_NORMAL,Font.WEIGHT_BOLDER,"Helvetica");var label2=new TextSymbol(label,font,new Color("black"));label2.setOffset(0,-23);g=new Graphic(geometry,label2);g.setAttributes({name:label,description:desc});drawGraphicsLayer.add(g);drawGraphicsLayer.setMinScale(wayPtMaxScale+1);drawGraphicsLayer.setMaxScale(0);map.addLayer(drawGraphicsLayer);drawGraphicsLayer.refresh();drawGraphicsLayer.content="<div class='esriPopupItemTitle'>Way Point found at map click:</div>"+"<form id='popupForm'>"+"<input id='wayPtTitle' type='text' style='width:150px;margin-left:5px;' value='"+label+"'></input>"+"<textarea id='wayPtDesc' onkeyup='javascript:resizeTextBox(this)' style='height:80px; width: calc(100% - 25px)!important;width: -moz-calc(100% - 25x)!important;width: -webkit-calc(100% - 25px)!important; margin:5px; overflow:hidden; resize:none;' "+" placeHolder=\"Description\">"+desc+"</textarea>"+"<p align='center'><button class='mblButton' type='button' onclick=\"var gr=map.getLayer('"+drawGraphicsLayer.id+"');"+"var result1=safeInput(document.getElementById('wayPtTitle'));"+"var result2=safeInput(document.getElementById('wayPtDesc'));"+"if(!result1 || !result2) return false;"+"gr.content = gr.content.replace(gr.title,document.getElementById('wayPtTitle').value);"+"gr.content = gr.content.replace(gr.desc+'</textarea>',document.getElementById('wayPtDesc').value+'</textarea>');"+"gr.title=document.getElementById('wayPtTitle').value;"+"gr.desc=document.getElementById('wayPtDesc').value;"+"gr.graphics[2].symbol.text = document.getElementById('wayPtTitle').value;"+"gr.refresh();"+"map.infoWindow.popupInfoView.container.style.display='none';"+"map.infoWindow.popupNavigationBar.container.style.display='none';"+"document.getElementById('wayPtDesc').blur();"+"document.body.focus();"+"\">Save</button>&nbsp;&nbsp;"+"<button type='button' class='mblButton' onclick='map.infoWindow.setTitle(\"\");map.infoWindow.setContent(\"\");"+"map.infoWindow.popupInfoView.container.style.display=\"none\";"+"map.infoWindow.popupNavigationBar.container.style.display=\"none\";' data-dojo-type='dojox/mobile/Button'>Close</button>&nbsp;&nbsp;"+"<button type='button' onclick='map.infoWindow.setTitle(\"\");"+"map.infoWindow.popupInfoView.container.style.display=\"none\";"+"map.infoWindow.popupNavigationBar.container.style.display=\"none\";"+"map.graphics.clear();"+"map.removeLayer(map.getLayer(\""+drawGraphicsLayer.id+"\"));"+"drawGraphicsCount.splice(drawGraphicsCount.indexOf(\""+drawGraphicsLayer.id+"\"),1);"+"map.infoWindow.setContent(\"\");' class='mblButton'>Delete</button></p><br/><br/></form>";drawGraphicsLayer.title=label;drawGraphicsLayer.desc=desc;drawGraphicsLayer.on("click",function(event){if(drawing)return;clickPoint=getScreenClick(event);map.infoWindow.setTitle(this.title);map.infoWindow.setContent(this.content);getIdentifyFooter();showIdentify();var supportsOrientationChange="onorientationchange"in window,orientationEvent=supportsOrientationChange?"orientationchange":"resize";window.addEventListener(orientationEvent,function(){setTimeout(resizeTextBox(document.getElementById("wayPtDesc")),500);},false);var gr=this;});drawGraphicsCount.push(drawGraphicsLayer.id);drawGraphicsCounter++;drawGraphicsLayer.on("mouse-over",function(){map.setMapCursor("pointer");});drawGraphicsLayer.on("mouse-out",function(){map.setMapCursor("default");});drawGraphicsLayer=null;label2=null;symbol2=null;});}
function drawInit(){require(["dojo/dom","dijit/registry","dojo/_base/lang","dojo/_base/Color","dojo/on","esri/toolbars/draw","esri/graphic","dojo/json","esri/config","esri/map","esri/geometry/Geometry","esri/geometry/Extent","esri/SpatialReference","esri/tasks/GeometryService","esri/tasks/LengthsParameters","esri/tasks/AreasAndLengthsParameters","esri/layers/FeatureLayer","esri/layers/LabelLayer","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleFillSymbol","esri/symbols/SimpleMarkerSymbol","esri/layers/GraphicsLayer","dijit/form/Select","esri/geometry/Point","esri/geometry/Polyline","esri/geometry/webMercatorUtils","esri/symbols/Font","esri/symbols/TextSymbol","esri/InfoTemplate"],function(dom,registry,lang,Color,on,Draw,Graphic,json,esriConfig,Map,Geometry,Extent,SpatialReference,GeometryService,LengthsParameters,AreasAndLengthsParameters,FeatureLayer,LabelLayer,SimpleLineSymbol,SimpleFillSymbol,SimpleMarkerSymbol,GraphicsLayer,Select,Point,Polyline,webMercatorUtils,Font,TextSymbol,InfoTemplate){var drawPtHandler1;function drawExit(){toolbar.deactivate();map.enableClickRecenter();map.enableDoubleClickZoom();map.showZoomSlider();}
function activateDrawTool(){drawing=true;dragging=false;closeMenu();document.getElementById('wayPtsPane').style.display='none';map.infoWindow.hide();var pointAdded=false;if(detectmob()){drawPtHandler1=on(dom.byId("mapDiv_layers"),"click",function(evt){if(measuring){if(pointAdded){lenGraphicsLayer.clear();}
if(!pointAdded){var geometry=getScreenClick(evt);var symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,5,null,new Color([255,0,0,1]));symbol.setOffset(0,-8);lenGraphicsLayer.add(new Graphic(geometry,symbol));pointAdded=true;}
return;}
else{drawIt(evt);}});}}
function outputLength(evtObj){var result=evtObj.result;console.log(json.stringify(result));var label=result.lengths[0].toFixed(1)+" miles";addLabel(labelPoint,label,lenGraphicsLayer,"11pt");}
function drawIt(evtObj){if(dragging){dragging=false;return;}
if(evtObj.stopImmediatePropagation)evtObj.stopImmediatePropagation();closeAlert();if(drawPtHandler1)drawPtHandler1.remove();var map=window.map;var geometry;geometry=getScreenClick(evtObj);if(geometry.type=="point"){addPoint(geometry,document.getElementById("wayPtInputTitle").value,document.getElementById("wayPtInputDesc").value,addPointSymbol());if(map.getScale()>wayPtMaxScale){alert("Zooming in to show way points...","",null,false);map.setScale(wayPtMaxScale);map.centerAt(geometry);}}
else if(geometry.type=="polyline"){lastPoint=false;pointAdded=false;measuring=false;document.getElementById("removeLengthBtn").style.visibility="visible";symbol=new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([255,0,10]),2);lenGraphicsLayer.add(new Graphic(geometry,symbol));labelPoint=new Graphic(new Point(geometry.paths[0][1],map.spatialReference));var lengthParams=new LengthsParameters();lengthParams.lengthUnit=GeometryService.UNIT_STATUTE_MILE;lengthParams.calculationType="geodesic";geometryService.simplify([geometry],function(simplifiedGeometries){lengthParams.polylines=simplifiedGeometries;geometryService.lengths(lengthParams);});}
geometryService.on("lengths-complete",outputLength);drawExit();geometry=null;drawing=false;}
var point=new Select({name:"pointStyle",id:"pointStyle",labelAttr:"label",options:[{label:"<span class='sprite sprite-ptsmblue'>",value:"smblue"},{label:"<span class='sprite sprite-ptsmgreen'></span>",value:"smgreen"},{label:"<span class='sprite sprite-ptsmgray'></span>",value:"smgray"},{label:"<span class='sprite sprite-ptsmred'></span>",value:"smred"},{type:"separator"},{label:"<span class='sprite sprite-ptmedblue'></span>",value:"medblue"},{label:"<span class='sprite sprite-ptmedgreen'></span>",value:"medgreen"},{label:"<span class='sprite sprite-ptmedgray'></span>",value:"medgray"},{label:"<span class='sprite sprite-ptmedred'></span>",value:"medred"},{type:"separator"},{label:"<span class='sprite sprite-ptlgblue'></span>",value:"lgblue"},{label:"<span class='sprite sprite-ptlggreen'></span>",value:"lggreen"},{label:"<span class='sprite sprite-ptlggray'></span>",value:"lggray"},{label:"<span class='sprite sprite-ptlgred'></span>",value:"lgred"}]},"pointStyleDiv");point.startup();point.set('value','medblue');function addPointSymbol(){var symbol;if(registry.byId("pointStyle").value.indexOf("smblue")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,7,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([0,0,200]),1),new Color([0,0,255,0.6]));else if(registry.byId("pointStyle").value.indexOf("medblue")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,14,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([0,0,200]),1),new Color([0,0,255,0.6]));else if(registry.byId("pointStyle").value.indexOf("lgblue")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,21,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([0,0,200]),1),new Color([0,0,255,0.6]));else if(registry.byId("pointStyle").value.indexOf("smgreen")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,7,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([0,150,5]),1),new Color([0,255,0,0.6]));else if(registry.byId("pointStyle").value.indexOf("medgreen")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,14,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([0,150,5]),1),new Color([0,255,0,0.6]));else if(registry.byId("pointStyle").value.indexOf("lggreen")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,21,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([0,150,5]),1),new Color([0,255,0,0.6]));else if(registry.byId("pointStyle").value.indexOf("smgray")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,7,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([100,100,100]),1),new Color([100,100,100,0.6]));else if(registry.byId("pointStyle").value.indexOf("medgray")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,14,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([100,100,100]),1),new Color([100,100,100,0.6]));else if(registry.byId("pointStyle").value.indexOf("lggray")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,21,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([100,100,100]),1),new Color([100,100,100,0.6]));else if(registry.byId("pointStyle").value.indexOf("smred")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,7,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([255,0,10]),1),new Color([255,0,0,0.6]));else if(registry.byId("pointStyle").value.indexOf("medred")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,14,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([255,0,10]),1),new Color([255,0,0,0.6]));else if(registry.byId("pointStyle").value.indexOf("lgred")>-1)
symbol=new SimpleMarkerSymbol(SimpleMarkerSymbol.STYLE_CIRCLE,21,new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,new Color([255,0,10]),1),new Color([255,0,0,0.6]));return symbol;}
function removeDistanceItem(){if(lenGraphicsCount.length==0)return;lenGraphicsCounter--;var layer=lenGraphicsCount.pop();map.removeLayer(map.getLayer(layer));if(lenGraphicsCount.length==0)
document.getElementById("removeLengthBtn").style.visibility="hidden";closeMenu();}
toolbar=new Draw(map);toolbar.on("draw-end",lang.hitch(map,drawIt));document.getElementById("wayPtForm").addEventListener("submit",function(event){event.stopImmediatePropagation();event.preventDefault();var result1=safeInput(dom.byId("wayPtInputTitle"));var result2=safeInput(dom.byId("wayPtInputDesc"));if(!result1||!result2)return;map.disableClickRecenter();activateDrawTool();toolbar.activate(Draw.POINT);map.hideZoomSlider();if(map.getScale()>wayPtMaxScale){alert("Zooming in to show way points...","",null,false);map.setScale(wayPtMaxScale);}
alert("Tap to add a way point","",null,false);document.getElementById("wayPtInputDesc").blur();document.body.focus();return false;});document.getElementById("lengthBtn").addEventListener("click",function(event){toolbar.activate(Draw.POLYLINE);measuring=true;if(lenGraphicsCount.length>0){lenGraphicsCounter--;var layer=lenGraphicsCount.pop();map.removeLayer(map.getLayer(layer));}
lenGraphicsLayer=new GraphicsLayer();lenGraphicsLayer.id="lengraphics"+lenGraphicsCounter;lenGraphicsCount.push(lenGraphicsLayer.id);lenGraphicsCounter++;map.addLayer(lenGraphicsLayer);map.disableDoubleClickZoom();activateDrawTool();map.hideZoomSlider();alert("Tap to enter 2 or more points. <button data-dojo-type='dojox/mobile/Button' class='mblButton' onclick='toolbar.finishDrawing()'>Done</button>","",null,false);});document.getElementById("removeLengthBtn").addEventListener("click",removeDistanceItem);});}