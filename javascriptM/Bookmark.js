define(["dojo/_base/declare","dijit/_WidgetBase","dijit/_TemplatedMixin","dijit/_WidgetsInTemplateMixin","dijit/_AttachMixin","dojo/text!javascript/templates/Bookmark.html","dojo/_base/lang","dojo/dom","dojo/on","dojo/dom-construct","dijit/registry","dijit/form/Button","dojo/_base/window","dojox/mobile","dojox/mobile/compat","dojox/mobile/parser","dojox/mobile/TabBar","dojox/mobile/TabBarButton","dojox/mobile/View","dojox/mobile/ScrollableView"],function(declare,_WidgetBase,_TemplatedMixin,_WidgetsInTemplateMixin,_AttachMixin,template,lang,dom,on,domConstruct,registry,Button,win,mobile,compat,parser,TabBar,TabBarButton,View,ScrollableView){widgetsInTemplate=true;var Bookmark=declare([_WidgetBase,_TemplatedMixin,_WidgetsInTemplateMixin,_AttachMixin],{templateString:template,defaultHelp:"This tool allows you to save the current map view including: way points, selected map layers, and base map layer in your <b>browser's bookmarks</b> or save "+"it to an icon on your home screen. The advantage to this is that you can clear your browser history, including cookies and your bookmarks will not be lost."+" The disadvantage is that browsers have a limit on the length of a URL address, so it may not be able to save all of your Way Points.<br/><br/>When you press the "+"'Create Bookmark' button the page will reload with a new URL address. Then to save it:<br/><br>On Chrome press the settings button "+"<img src='assets/images/androidBookmark.png'/>, then press the star button or select 'Add to Home Screen'.<br/><br/>On iPhone press the settings button "+"<img src='assets/images/iosBookmark.png' style='height:26px'/>, then select 'Add Bookmark' or 'Add to Home Screen'."+"<br/><br/><strong>Email a Bookmark</strong>: If you would like to email the current map use 'Email Link' located in Links in the main menu. Good for a limited number "+"of Way Points.<br/><br/>",constructor:function(params){lang.mixin(this,params);params=params||{};},startup:function(){this._setBookmarks();},_loadKml:function(){require(["esri/layers/KMLLayer","esri/geometry/webMercatorUtils","esri/graphicsUtils","dojo/_base/array","esri/symbols/SimpleLineSymbol","esri/symbols/SimpleMarkerSymbol","dojo/_base/Color"],function(KMLLayer,webMercatorUtils,graphicsUtils,array,SimpleLineSymbol,SimpleMarkerSymbol,Color){showLoading();esri.config.defaults.io.proxyUrl="/proxy/DotNet/proxy.ashx";esriConfig.defaults.io.alwaysUseProxy=false;var url=document.getElementById("kmlFile").value;var kmlExtent=null;var kmlLayer=new KMLLayer(url);map.addLayer(kmlLayer);closeMenu();slideLeft(document.getElementById('bookmarkPane'));var kmlCreated=kmlLayer.on("load",function(evt){kmlCreated.remove();console.log(evt.layer.id);var kmlExtent=null,layers=kmlLayer.getLayers();var lyrExtent=null;if(layers[0].folders)
console.log("Folders="+layers[0].folders.length);if(layers[0].graphics)
console.log("Graphics="+layers[0].graphics.length);dojo.forEach(layers,function(lyr){if(lyr.graphics&&lyr.graphics.length>0){if(lyr.graphics[0].geometry.spatialReference.wkid==4326)
lyrExtent=webMercatorUtils.geographicToWebMercator(graphicsUtils.graphicsExtent(lyr.graphics));else if(lyr.graphics[0].geometry.spatialReference.wkid==102100)
lyrExtent=graphicsUtils.graphicsExtent(lyr.graphics);else alert("need to convert spatial reference");if(lyrExtent)(kmlExtent)?kmlExtent.union(lyrExtent):kmlExtent=lyrExtent;}});if(kmlExtent)map.setExtent(kmlExtent);hideLoading();});kmlLayer.on("error",function(e){hideLoading();alert(e.error.message,"Warning");});});},_hideAll:function(){document.getElementById("addBookmark").style.display="none";document.getElementById("addBrowserBookmark").style.display="none";document.getElementById("bmBtn").className="buttonBar";document.getElementById("brBtn").className="buttonBar";},_showAddBookmark:function(){this._hideAll();document.getElementById("addBookmark").style.display="block";document.getElementById("bmBtn").className="buttonBarSelected";bmHelp.setContent('This tool allows you to save the current map view including: way points, selected map layers, and base map layer in your browser\'s local storage. '+'If you delete your browser history be sure to uncheck \"cookies & other site data\" to keep your bookmarks. The disadvantage to this is that you can never '+'clear your cookies. Also, Safari on mobile recently removed this option so it always deletes all of your cookies, therefore clearing history will delete all '+'of your saved bookmarks. There is a limit of 5mb that can be stored per website domain. '+'<br/><br/><strong>Add a Bookmark: </strong>Enter a label for your boomark and press the Add button.'+'<br/><br/><strong>Load a Bookmark: </strong>Click on the label or <img style="vertical-align:middle; height:30px;" src="assets/images/i_bookmark.png"/> button to load a bookmark.'+'<br/><br/><strong>Remove a Bookmark: </strong>Clicking on the <img style="vertical-align:middle" src="assets/images/w_close_red.png"/> button will delete a bookmark.'+'<br/><br/><strong>Email a Bookmark</strong>: If you would like to email the current map use "Email Link" '+'located in Links in the main menu.  Good for a limited number of Way Points.'+'<br/><br/>');},_showBrowserBookmark:function(){this._hideAll();document.getElementById("addBrowserBookmark").style.display="block";document.getElementById("brBtn").className="buttonBarSelected";bmHelp.setContent(this.defaultHelp);},_setBookmarks:function(){try{var bmNames=getCookie("bm_"+app.toLowerCase());if(bmNames!=""){var names=bmNames.split("*");for(var i=0;i<names.length;i++){var value=getCookie("bm"+app.toLowerCase()+"_"+names[i]);value=value.replace(/\$/g,";");this._updateBookmarkContent(value);}}else{this._updateBookmarkContent("Colorado|-12350000,4250000,-11150000,5250000");setCookie("bm"+app.toLowerCase()+"_Colorado","Colorado|-12350000,4250000,-11150000,5250000");setCookie("bm_"+app.toLowerCase(),"Colorado");}}catch(e){alert("Error in javascript/bookmark.js _setBookmarks() "+e.message,"Code Error",e);}},_updateBookmarkContent:function(value){try{var pos=value.indexOf("|");var name=value.substring(0,pos);var cfg=value.substring(pos+1);cfg=cfg.replace(/%0D/g,"\n").replace(/%3F/g,"?").replace(/%22/g,'"').replace(/%27/g,"'").replace(/%26/g,"&");var bmLink=domConstruct.create("span",{style:{textDecoration:"none",cursor:"pointer"},id:"link"+name,innerHTML:"<img style='vertical-align:middle;' src='assets/images/i_bookmark.png'/> "+name});on(bmLink,"click",lang.hitch(this,function(e){this._loadBookmark(cfg);}));var bmCloseBtn=domConstruct.create("img",{src:'assets/images/w_close_red.png',style:{cursor:"pointer",position:"relative",float:"right",right:"10px",height:"30px"},id:name,onclick:lang.hitch(this,function(e){this._removeBookmark(e.currentTarget.id);})});var bmBR1=domConstruct.create("br",{id:"br1"+name});var bmBR2=domConstruct.create("br",{id:"br2"+name});domConstruct.place(bmLink,this.bookmarkTab,"before");domConstruct.place(bmCloseBtn,this.bookmarkTab,"before");domConstruct.place(bmBR1,this.bookmarkTab,"before");domConstruct.place(bmBR2,this.bookmarkTab,"before");}catch(e){alert("Error in javascript/bookmark.js _updateBookmarkContent() "+e.message,"Code Error",e);}},_loadBrowserBookmark:function(e){require(["javascript/graphicFuncs"],function(graphicFuncs){var url=graphicFuncs.getMapLink();showLoading();window.location.assign(url);});},_addBookmark:function(e){try{var str;var bmNames=getCookie("bm_"+app.toLowerCase());var name=this.bookmarkName.value;if(name==""){alert("Must give the bookmark a name.","Note");return;}
if(name.indexOf("|")>-1||name.indexOf("$")>-1){alert("Bookmark name cannot contain the '|' or the '$' character.","Note");return;}
var cfg=map.extent.xmin+","+map.extent.ymin+","+map.extent.xmax+","+map.extent.ymax;var my=this;require(["javascript/graphicFuncs"],function(graphicFuncs){str=graphicFuncs.mlGetPoints();if(str)
cfg+=str;if(typeof getHB1298Points==="function"){if(!str)str="";str=getHB1298Points();if(str&&str!="")cfg+=str;}
str=graphicFuncs.mlGetLayers();if(str)
cfg+=str;cfg=cfg.replace(/;/g,"$");str=name+"|"+cfg;my._updateBookmarkContent(str);if(bmNames.length>0)
bmNames+="*";bmNames+=name;setCookie("bm_"+app.toLowerCase(),bmNames);setCookie("bm"+app.toLowerCase()+"_"+name,str);});this.bookmarkName.value="";this.bookmarkName.blur();document.body.focus();}catch(e){alert("Error in javascript/bookmark.js _addBookmark() "+e.message,"Code Error",e);}},_loadBasemapsToc:function(cfg,bm){initBasemaps();var timer=setInterval(function(){if(document.getElementById("basemapLoading").style.display=="none"){clearInterval(timer);basemapFlag=true;bm._loadBookmark(cfg);}},50);},_loadBookmark:function(cfg){try{showLoading();if(cfg.indexOf("layer=")&&!basemapFlag){this._loadBasemapsToc(cfg,this);return;}
document.getElementById("menuView").style.display="none";document.getElementById('swipeleft').style.display='none';slideLeft(document.getElementById('bookmarkPane'));var i;if(typeof hb1298GraphicsLayer!="undefined")hb1298GraphicsLayer.clear();if(typeof drawGraphicsLayer!="undefined"){for(i=0;i<drawGraphicsCounter;i++)
map.removeLayer(map.getLayer(drawGraphicsCount[i]));drawGraphicsCounter=0;drawGraphicsCount=[];}
require(["esri/geometry/Extent","esri/SpatialReference","dojo/dom","dijit/registry","javascript/graphicFuncs"],function(Extent,SpatialReference,dom,registry,graphicFuncs){cfg=cfg.replace(/\$/g,";");var value=cfg.split("&");var extArr=value[0].split(",");var ext;ext=new Extent({"xmin":parseFloat(extArr[0]),"ymin":parseFloat(extArr[1]),"xmax":parseFloat(extArr[2]),"ymax":parseFloat(extArr[3]),"spatialReference":{"wkid":wkid}});map.setExtent(ext);extArr=null;if(value.length==1)
return;var sr=new SpatialReference(map.spatialReference);for(var m=1;m<value.length;m++){if(value[m].indexOf("layer=")>-1){var basemapGallery=registry.byId("basemapGallery");var pos=value[m].indexOf("|");var basemap=value[m].substring(6,pos);var title;for(var g=0;g<basemapGallery.basemaps.length;g++){if(basemap==basemapGallery.basemaps[g].id){title=basemapGallery.basemaps[g].title;break;}}
var basemapDom=dom.byId("galleryDiv").firstChild.children;for(var p=0;p<basemapDom.length;p++){if(basemapDom[p].children[1].childNodes[0].nodeValue==title){basemapDom[p].attributes.class.nodeValue="thumbnailcontainer small selected";basemapDom[p].children[0].attributes.class.nodeValue="thumbnail small selected";basemapDom[p].children[1].attributes.class.nodeValue="title small selected";basemapDom[p].children[2].attributes.class.nodeValue="title small selected";}else{basemapDom[p].attributes.class.nodeValue="thumbnailcontainer small";basemapDom[p].children[0].attributes.class.nodeValue="thumbnail small";basemapDom[p].children[1].attributes.class.nodeValue="title small";basemapDom[p].children[2].attributes.class.nodeValue="title small";}}
basemapGallery.select(basemap);mapBasemap=basemap;var layersArr=value[m].substring(pos+1).split(",");var layer=map.getLayersVisibleAtScale();gmu="Big Game GMU";var n;var num=new Array(0,1,2,3,4,5,6,7,8,9);var layerArr;for(var j=0;j<layer.length;j++){var found=false;for(var i=0;i<layersArr.length;i++){layerArr=layersArr[i].split("|");if(layer[j].id.indexOf("graphics")>-1){found=true;continue;}
if(layer[j].id==layerArr[0]){found=true;continue;}}
if(!found)
layer[j].hide();}
for(i=0;i<layersArr.length;i++){var layerArr=layersArr[i].split("|");for(j=0;j<layer.length;j++){if(layer[j].id==layerArr[0]){layer[j].setOpacity(parseFloat(layerArr[1]));if(layerArr[3]){if(layerArr[3]=="1")
layer[j].show();else
layer[j].hide();}else
layer[j].show();if(layerArr[2]=="-1"){layer[j].setVisibleLayers([-1]);}else{var visLayers=layerArr[2].split("-");for(var k=0;k<visLayers.length;k++)
visLayers[k]=visLayers[k]|0;var layerInfos=[];layerInfos=layer[j].layerInfos;if(layer[j].id=="Hunter Reference"){for(var v=0;v<visLayers.length;v++){if(layerInfos[visLayers[v]].name.substr(layerInfos[visLayers[v]].name.length-3,3).indexOf("GMU")>-1){gmu=layerInfos[visLayers[v]].name;break;}}}else if(layer[j].id=="Game Species"){for(v=0;v<visLayers.length;v++){if(layerInfos[visLayers[v]].name==="Bighorn Sheep"){gmu="Bighorn GMU";break;}else if(layerInfos[visLayers[v]].name==="Mountain Goat"){gmu="Goat GMU";break;}}}
for(k=0;k<layerInfos.length;k++){if(visLayers.indexOf(layerInfos[k].id)!=-1)
layerInfos[k].visible=true;else if(layerInfos[k].parentLayerId!=-1&&!layerInfos[k].subLayerIds){if(layerInfos[k].name.substr(layerInfos[k].name.length-3,3).indexOf("GMU")>-1){if(layerInfos[k].name==gmu){if(visLayers.indexOf(m)==-1){layerInfos[k].visible=true;}
if((num.indexOf(parseInt(layerInfos[layerInfos[k].parentLayerId].name.substr(0,1)))>-1)&&(visLayers.indexOf(layerInfos[k].parentLayerId)==-1)){layerInfos[layerInfos[k].parentLayerId].visible=true;}}else
layerInfos[k].visible=false;}else if((layerInfos[k].defaultVisibility==true)&&(visLayers.indexOf(layerInfos[k].parentLayerId)===-1)){if(num.indexOf(parseInt(layerInfos[layerInfos[k].parentLayerId].name.substr(0,1)))>-1){layerInfos[layerInfos[k].parentLayerId].visible=true;}}}else{layerInfos[k].visible=false;}
var pos=visLayers.indexOf(layerInfos[k].id);if(pos>-1&&layerInfos[k].subLayerIds)
visLayers.splice(pos,1);}
layer[j].setVisibleLayers(visLayers.sort(function(a,b){return a-b}),false);layer[j].refresh();visLayers=null;}}}}}else if(value[m].indexOf("point=")>-1){require(["javascript/graphicFuncs"],function(graphicFuncs){graphicFuncs.addPoints(value[m].substring(6),sr);});}
else if(typeof addHB1298Points==="function"&&value[m].indexOf("hb1298=")>-1)
addHB1298Points(value[m].substring(7));}
var toc=registry.byId("tocDiv");toc.refresh();});hideLoading();}catch(e){alert("Error in javascript/bookmark.js _loadBookmark() "+e.message,"Code Error",e);}},_removeBookmark:function(name){try{var newBM="";var value=getCookie("bm_"+app.toLowerCase());var bmArr=value.split("*");for(var i=0;i<bmArr.length;i++){var thisName=bmArr[i];if(name!=thisName){if(newBM!=""&&thisName!="")
newBM+="*";newBM+=bmArr[i];}}
setCookie("bm_"+app.toLowerCase(),newBM);deleteCookie("bm"+app.toLowerCase()+"_"+name);domConstruct.destroy("link"+name);domConstruct.destroy(name);domConstruct.destroy("br1"+name);domConstruct.destroy("br2"+name);}catch(e){alert("Error in javascript/bookmark.js _removeBookmark() "+e.message,"Code Error",e);}}});return Bookmark;});