function printInit(){var e=createXMLhttpRequest(),i=app+"/PrintPdfWidget.xml?v="+ndisVer;e.onreadystatechange=function(){if(4===e.readyState&&200===e.status){var i=createXMLdoc(e);i.getElementsByTagName("disclaimer")[0]?prtDisclaimer=i.getElementsByTagName("disclaimer")[0].firstChild.nodeValue:alert("Missing tag, disclaimer, in "+app+"/PrintPdfWidget.xml file.","Data Error"),i.getElementsByTagName("helpvideo")[0]&&(document.getElementById("printVideo").innerHTML="<a target='help' href="+i.getElementsByTagName("helpvideo")[0].firstChild.nodeValue+">Click here to view help video.</a><br/><br/>")}else 404===e.status?(alert("Error: Missing PrintPdfWidget.aspx file in "+app+" directory.","Data Error"),hideLoading()):4===e.readyState&&500===e.status&&(alert("Missing PrintPdfWidget.aspx file. app="+app,"Data Error"),hideLoading())},e.open("GET",i,!0),e.send()}function printShow(){require(["esri/SpatialReference","esri/layers/GraphicsLayer","esri/graphic","esri/layers/ArcGISTiledMapServiceLayer","esri/layers/ArcGISDynamicMapServiceLayer","esri/geometry/Point","esri/layers/VectorTileLayer","esri/layers/OpenStreetMapLayer","dojo/dom","dojo/on","dojo/_base/array"],function(e,t,n,r,a,d,l,p,s,o,y){function g(e){"none"!==s.byId("printDiv").style.display&&require(["esri/layers/FeatureLayer"],function(i){D[e]++;var t=new i(map.getLayer(e).url,{opacity:Number(map.getLayer(e).opacity),id:e,visible:map.getLayer(e).visible});B.push(o(t,"error",m)),B.push(o(t,"load",c))})}function c(e){e.layer.refresh(),previewMap.addLayer(e.layer)}function m(e){D[e.target.id]<5?setTimeout(function(){g(e.target.id)},500):5==D[e.target.id]?(e.target.id.indexOf("Motor Vehicle")>-1||e.target.id.indexOf("Wildfire")>-1||e.target.id.indexOf("BLM")>-1?alert("While printing, the external map service that provides "+e.target.id+" is experiencing problems.  This issue is out of CPW control. We will continue trying to load it. We apologize for any inconvenience.","External (Non-CPW) Map Service Error"):alert("While printing, the "+e.target.id+" service is busy or not responding. We will continue trying to load it.","Data Error"),setTimeout(function(){g(e.target.id)},500)):setTimeout(function(){g(e.target.id)},1e3)}function u(e){if("none"!==s.byId("printDiv").style.display){D[e.id]++;for(var i=[],t=0;t<e.visibleLayers.length;t++)i.push(parseInt(e.visibleLayers[t]));var n=new a(e.url,{opacity:parseFloat(e.opacity),id:e.id,visible:e.visible});n.setVisibleLayers(i),i=null,B.push(o(n,"error",f)),B.push(o(n,"load",L)),printDialog.on("hide",h)}}function h(e){y.forEach(B,function(e){e.remove()}),B=[]}function f(e){D[e.target.id]<5?setTimeout(function(){u(map.getLayer(e.target.id))},500):5===D[e.target.id]?(e.target.id.indexOf("Motor Vehicle")>-1||e.target.id.indexOf("Wildfire")>-1||e.target.id.indexOf("BLM")>-1?alert("While printing, the external map service that provides "+e.target.id+" is experiencing problems.  This issue is out of CPW control. We will continue trying to load it. We apologize for any inconvenience.","External (Non-CPW) Map Service Error"):alert("While printing, the "+e.target.id+" service is busy or not responding. We will continue trying to load it.","Data Error"),setTimeout(function(){u(map.getLayer(e.target.id))},500)):setTimeout(function(){u(map.getLayer(e.target.id))},1e3)}function L(e){D[e.target.id]>5&&alert("While printing, the "+e.target.id+" service loaded sucessfully.","Note");var t,n=e.layer;O++;var r=n.visibleLayers,a=n.layerInfos;for(j=0;j<n.visibleLayers.length;j++){k=n.visibleLayers[j];do{if(hideGroupSublayers.indexOf(a[k].name)>-1&&a[k].subLayerIds)for(t=0;t<a[k].subLayerIds.length;t++)if(-1==r.indexOf(a[k].subLayerIds[t])&&r.push(a[k].subLayerIds[t]),"Big Game GMU"==a[a[k].subLayerIds[t]+1].name){var d=1;"Bighorn GMU"==gmu?d=2:"Goat GMU"==gmu&&(d=3),-1==r.indexOf(a[k].subLayerIds[t]+d)&&r.push(a[k].subLayerIds[t]+d)}else-1==r.indexOf(a[k].subLayerIds[t]+1)&&r.push(a[k].subLayerIds[t]+1);k=a[k].parentLayerId}while(-1!=k)}var l=new Array(0,1,2,3,4,5,6,7,8,9);for(t=0;t<a.length;t++){-1!=r.indexOf(a[t].id)?a[t].visible=!0:-1==a[t].parentLayerId||a[t].subLayerIds?a[t].visible=!1:a[t].name.substr(a[t].name.length-3,3).indexOf("GMU")>-1?a[t].name==gmu?(-1==r.indexOf(t)&&(a[t].visible=!0),l.indexOf(parseInt(a[a[t].parentLayerId].name.substr(0,1)))>-1&&-1==r.indexOf(a[t].parentLayerId)&&(a[a[t].parentLayerId].visible=!0)):a[t].visible=!1:1==a[t].defaultVisibility&&-1===r.indexOf(a[t].parentLayerId)&&l.indexOf(parseInt(a[a[t].parentLayerId].name.substr(0,1)))>-1&&(a[a[t].parentLayerId].visible=!0);var p=r.indexOf(a[t].id);p>-1&&a[t].subLayerIds&&r.splice(p,1)}if(n.setVisibleLayers(r.sort(function(e,i){return e-i}),!1),n.refresh(),n.spatialReference=T,H.push(n),O==P){for(i=0;i<S.length;i++)for(j=0;j<H.length;j++)S[i]==H[j].id&&previewMap.addLayer(H[j]);H=null,S=null}}var I,b,v,w,M,x,E,T=new e({wkid:wkid}),B=[],P=0,O=0,H=[],S=[],D=[];for(document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="",document.getElementById("printTitle").value="My Custom Map",document.getElementById("printSubTitle").value=s.byId("title").innerHTML,previewMap.removeAllLayers(),printDialog.show(),i=0;i<map.layerIds.length;i++)b=map.getLayer(map.layerIds[i]),"layer_osm"==map.layerIds[i]?(v=new p,v.id="layer_osm",previewMap.addLayer(v),v=null):b.attributionDataUrl&&b.attributionDataUrl.indexOf("OpenStreet")>-1?(v=new p,v.id="layer_osm",previewMap.addLayer(v),v=null):map.layerIds[i].indexOf("layer")>-1&&1==map.getLayer(map.layerIds[i]).visibleAtMapScale&&(map.getLayer(map.layerIds[i]).url.indexOf("MapServer")>-1?I=new r(map.getLayer(map.layerIds[i]).url,{id:"basemap",visible:!0}):(I=new l(map.getLayer(map.layerIds[i]).url,{id:"basemap",visible:!0}),I.setStyle(map.getLayer(map.layerIds[i]).url)),"reference"==b._basemapGalleryLayerType?I.id="reference":i>0&&(I.id="basemap"+i),I.spatialReference=map.spatialReference,I._basemapGalleryLayerType=b._basemapGalleryLayerType,I.refresh(),previewMap.addLayer(I),I=null);for(i=0;i<map.layerIds.length;i++)b=map.getLayer(map.layerIds[i]),0!=b.id.indexOf("layer")&&(b.attributionDataUrl&&b.attributionDataUrl.indexOf("OpenStreet")>-1||b.layerInfos&&b.visible&&(P++,S.push(b.id)));for(i=0;i<map.layerIds.length;i++)b=map.getLayer(map.layerIds[i]),b.attributionDataUrl&&b.attributionDataUrl.indexOf("OpenStreet")>-1||map.layerIds[i].indexOf("layer")>-1||b.layerInfos&&b.visible&&(D[b.id]=0,u(b));for(i=0;i<map.graphicsLayerIds.length;i++)if(map.graphicsLayerIds[i].indexOf("drawgraphics")>-1||map.graphicsLayerIds[i].indexOf("drawtextgraphics")>-1){for(w=new t,w.id=map.graphicsLayerIds[i],w.visible=!0,w.spatialReference=previewMap.spatialReference,M=map.getLayer(map.graphicsLayerIds[i]).graphics,x=0;x<M.length;x++)E=M[x].clone(),w.add(E);previewMap.addLayer(w),w=null,M=null}else map.graphicsLayerIds[i].indexOf("Wildfire")>-1&&(D[map.graphicsLayerIds[i]]=0,g(map.graphicsLayerIds[i]));if("undefined"!=typeof hb1298GraphicsLayer){for(w=new t,w.visible=!0,w.spatialReference=previewMap.spatialReference,M=map.getLayer(map.graphicsLayerIds[i]).graphics,x=0;x<hb1298GraphicsLayer.graphics.length;x++)E=M[x].clone(),w.add(E);previewMap.addLayer(w),w=null,M=null}previewMap.spatialReference=T;var W=new d(map.extent.xmax+(map.extent.xmin-map.extent.xmax)/2,map.extent.ymin+(map.extent.ymax-map.extent.ymin)/2,T);previewMap.centerAndZoom(W,map.getLevel()).then(function(){changePrintSize()}),W=null,T=null})}function changePrintSize(){require(["dojo/dom","dijit/registry"],function(e,i){if(previewMap&&previewMap.extent){document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="";document.getElementById("printPreviewMap");var t=e.byId("orient");index=t.selectedIndex;var n=t.options[index].value,r=e.byId("size");index=r.selectedIndex;var a=r.options[index].value,d=previewMap.extent.getCenter(),l=previewMap.getLevel();"Landscape"==n?"Letter "==a?(previewMap.width=490,previewMap.height=348,inchesWidth=10.2,inchesHeight=7.25,i.byId("printPreviewMap").resize({w:490,h:348})):"Tabloid "==a?(previewMap.width=544,previewMap.height=328,inchesWidth=16.2,inchesHeight=8.75,i.byId("printPreviewMap").resize({w:544,h:328})):"8.5 x 14 "==a&&(previewMap.width=506,previewMap.height=278,inchesWidth=13.2,inchesHeight=7.25,i.byId("printPreviewMap").resize({w:506,h:278})):"Letter "==a?(previewMap.width=370,previewMap.height=468,inchesWidth=7.7,inchesHeight=9.75,i.byId("printPreviewMap").resize({w:370,h:468})):"Tabloid "==a?(previewMap.width=343,previewMap.height=529,inchesWidth=10.2,inchesHeight=15.75,i.byId("printPreviewMap").resize({w:343,h:529})):"8.5 x 14 "==a&&(previewMap.width=296,previewMap.height=490,inchesWidth=7.7,inchesHeight=12.75,i.byId("printPreviewMap").resize({w:296,h:490})),l>-1&&previewMap.centerAndZoom(d,l),d=null}else alert("Please wait for page to load.")})}function grayOutLegend(e){require(["dojo/dom"],function(i){document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="","geopdf"!=e.value&&"pdf"!=e.value&&i.byId("printLegend")?i.byId("printLegendCB").style.display="none":i.byId("printLegendCB").style.display="inline-block","geotiff"!=e.value?document.getElementById("printInst").innerHTML="Disable pop-up blocker. Printout will open in a new tab.":document.getElementById("printInst").innerHTML=""})}function printMap(){require(["esri/tasks/PrintTask","esri/tasks/PrintTemplate","esri/tasks/PrintParameters","esri/urlUtils","esri/config","esri/graphic","esri/geometry/Point","esri/tasks/LegendLayer","esri/layers/GraphicsLayer","dojo/dom","dijit/registry"],function(e,i,t,n,r,a,d,l,p,s,o){function y(e){var i,t,n=s.byId("format"),r=Date.now()-startTim,a=previewMap.getScale();a<9028?t="10k":a<36112?t="24k":a<72224?t="50k":a<144448?t="100k":a<288896?t="250k":a<577791?t="500k":a<1155582?t="1M":a<2311163?t="2M":a<4622325?t="4M":a<9244649&&(t="9M");var d=n.options[n.selectedIndex].value,l=s.byId("size").options[s.byId("size").selectedIndex].innerHTML+" "+d+" ";L&&document.getElementById("printLegend").checked&&(l+="legend ");var p=s.byId("size").options[s.byId("size").selectedIndex].innerHTML,y=s.byId("size").options[s.byId("size").selectedIndex].innerHTML,g=Math.floor(r/1e3),c="Print ";switch(d){case"pdf":c+="PDF";break;case"geopdf":c+="geoPDF";break;case"jpg":c+="JPG";break;case"geotiff":c+="geoTIFF";break;case"gif":c+="GIF"}var m,u="";for(i=0;i<previewMap.layerIds.length;i++)switch(previewMap.layerIds[i]){case"Motor Vehicle Use Map":u+="M";break;case"Hunter Reference":u+="R";break;case"Game Species":u+="G";break;case"Fishing Info":u+="F";break;case"Reference":u+="R"}if(l+=u,m={metric1:g,dimension2:p,dimension3:u,dimension4:t,dimension5:d},console.log("Time to create map = "+g+" seconds for "+l+" "+t),"function"==typeof ga&&ga("send","event",l,y,c,g,m),console.log("printing to "+e.url),e.url.indexOf("tif")>-1||e.url.indexOf("svgz")>-1)document.getElementById("printInst").innerHTML="Click on the link below to download the image file.",document.getElementById("printMapLink").innerHTML="<a href='"+e.url+"' target='_blank'>"+B.format.toUpperCase()+" File</a>";else{document.getElementById("printInst").innerHTML="Disable pop-up blocker. Printout will open in a new tab.";try{window.open(e.url,"_blank")}catch(e){console.log("Can't open printout in new window. Use link provided.")}document.getElementById("printMapLink").innerHTML="Opened map in a new tab.<br/>Link to <a href='"+e.url+"' target='_blank'>"+B.format.toUpperCase()+" File</a>"}for(i=0;i<h;i++)removeDrawItem();f&&(o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none"),f=!0}function g(e){o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none",alert("Error printing with basemap, "+mapBasemap+". Error Code: "+e,"Code Error",e),document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="";for(var i=0;i<h;i++)removeDrawItem();printDialog.hide()}function c(e){console.log("printing legend to "+e.url);try{window.open(e.url,"_blank")}catch(e){console.log("Can't open printout in new window. Use link provided.")}f&&(o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none"),document.getElementById("printLegendLink").innerHTML="Opened legend in a new tab.Link to <a href='"+e.url+"' target='_blank'>"+B.format.toUpperCase()+" File</a>",f=!0}function m(e){o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none",document.getElementById("printLegendLink").innerHTML="",document.getElementById("printMapLink").innerHTML="",e.details?alert("Error printing the legend: "+e+e.details,"Code Error",e):alert("Error printing the legend: "+e,"Code Error",e),printDialog.hide()}var u,h=0;try{var f=!1,L="inline-block"==s.byId("printLegendCB").style.display;L||(f=!0),o.byId("print_button").set("label","Creating..."),document.getElementById("printLoading").style.display="inline-block",document.getElementById("printMapLink").innerHTML="",document.getElementById("printLegendLink").innerHTML="";var I,b,v=previewMap.getLayersVisibleAtScale(),w=[],M=0;for(u=1;u<v.length;u++)if(v[u].visible&&"topo"!=v[u].id&&"streets"!=v[u].id&&"hybrid"!=v[u].id){if(v[u].id.indexOf("drawgraphics")>0){if(v[u].graphics.length>1&&"point"==v[u].graphics[0].geometry.type&&!v[u].graphics[0].symbol.text){h++;var x=new d(v[u].graphics[0].geometry.x,v[u].graphics[0].geometry.y,map.spatialReference),k=new a(x),E=new p;E.id="drawgraphics"+drawGraphicsCounter,drawGraphicsCount.push(E.id),drawGraphicsCounter++,addLabel(k,v[u].graphics[1].symbol.text,E,"11pt")}continue}v[u].visibleLayers&&(I=new l,I.layerId=v[u].id,I.subLayerIds=v[u].visibleLayers,w.push(I),I=null,M++)}var T=new t,B=new i,P=s.byId("orient"),O=s.byId("format");index=P.selectedIndex;var H=P.options[index].value,S=s.byId("size");index=S.selectedIndex;var D=S.options[index].value;if(B.exportOptions={dpi:dpi,width:parseInt(inchesWidth*dpi),height:parseInt(inchesHeight*dpi)},"pdf"!=O.options[O.selectedIndex].value){var W;if(B.layout=app+" "+D+H,b=new e(printGeoServiceUrl),B.preserveScale=!1,f=!0,B.format=O.options[O.selectedIndex].value,"geopdf"!=B.format)W="none",B.exportOptions={dpi:dpi,width:parseInt(inchesWidth*dpi),height:parseInt(inchesHeight*dpi)};else if("geopdf"!=B.format||document.getElementById("printLegend").checked)W="Legend Letter "+H,B.format="pdf";else if(W="none",B.format="pdf",0==M)return alert("Printing of basemaps alone does not work. Please add map layers. From the menu, select 'Map Layers & Legend.'","Warning"),o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none",document.getElementById("printMapLink").innerHTML="",void(document.getElementById("printLegendLink").innerHTML="");T.extraParameters={Georef_Info:"True",Legend_Template:W}}else L&&!document.getElementById("printLegend").checked&&(f=!0),b=new e(printServiceUrl),B.preserveScale=!1,B.format=O.options[O.selectedIndex].value.toUpperCase(),D.indexOf("Letter")>-1?B.layout=D+"ANSI A "+H:B.layout=D+"ANSI B "+H;B.showAttribution=!1;var C=document.getElementById("printTitle").value;if("geopdf"==O.options[O.selectedIndex].value&&(C+=" (Geo PDF)"),L&&document.getElementById("printLegend").checked?B.layoutOptions={titleText:C,authorText:prtDisclaimer,legendLayers:w,customTextElements:[{Subtitle:document.getElementById("printSubTitle").value},{Legend:w}]}:B.layoutOptions={titleText:C,authorText:prtDisclaimer,legendLayers:[],customTextElements:[{Subtitle:document.getElementById("printSubTitle").value}]},C=null,T.map=previewMap,T.template=B,!fullExtent.contains(previewMap.extent))return alert("Printing is only allowed for Colorado.","Warning"),o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none",document.getElementById("printMapLink").innerHTML="",void(document.getElementById("printLegendLink").innerHTML="");if(b.execute(T,y,g),startTim=Date.now(),"pdf"==O.options[O.selectedIndex].value&&L&&document.getElementById("printLegend").checked){var G=new e(printServiceUrl),_=new t,U=new i;U.exportOptions={dpi:dpi},U.layout="Legend Letter "+H,U.format="PDF",U.layoutOptions={titleText:document.getElementById("printTitle").value,authorText:prtDisclaimer,legendLayers:w,customTextElements:[{Subtitle:document.getElementById("printSubTitle").value},{Legend:w}]},_.map=previewMap,_.template=U,G.execute(_,c,m)}}catch(e){for(u=0;u<h;u++)removeDrawItem();alert("Error while printing: "+e.message,"Code Error",e),o.byId("print_button").set("label","Print"),document.getElementById("printLoading").style.display="none"}})}var startTim,inchesWidth,inchesHeight,prtDisclaimer="",dpi=96;